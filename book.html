<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Michie Auto Detailing - Book an Appointment</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: #334155;
            padding-bottom: 80px;
        }
        .pac-container { z-index: 1050 !important; }

        .btn-primary {
            background-color: #3b82f6;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: none;
        }
        .btn-primary:hover {
            background-color: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 6px 10px -1px rgba(0, 0, 0, 0.15), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
        }
        .btn-success {
            background-color: #22c55e;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: none;
        }
        .btn-success:hover {
            background-color: #16a34a;
            transform: translateY(-2px);
            box-shadow: 0 6px 10px -1px rgba(0, 0, 0, 0.15), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
        }

        .pricing-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }
        @media (min-width: 768px) { .pricing-grid { grid-template-columns: repeat(3, 1fr); } }
        
        .pricing-card {
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 1rem;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            height: 100%;
        }
        .pricing-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 30px rgba(0, 123, 255, 0.1);
        }
        .pricing-level { font-size: 1.5rem; font-weight: 700; color: #1e293b; margin-bottom: 0.75rem; }
        .pricing-price { font-size: 2.5rem; font-weight: 800; color: #059669; margin-bottom: 1.5rem; }
        .feature-list { list-style: none; padding: 0; text-align: left; flex-grow: 1; margin-bottom: 1.5rem; }
        .feature-list li { position: relative; padding-left: 2rem; margin-bottom: 0.8rem; color: #475569; font-size: 0.95rem; }
        .feature-list li::before { content: 'âœ“'; color: #059669; position: absolute; left: 0; font-weight: bold; font-size: 1.2rem; }
        .select-package-btn { width: 100%; margin-top: auto; }
        .see-whats-included-btn { background-color: #eff6ff; color: #1e40af; font-weight: 500; padding: 0.6rem 1.2rem; border-radius: 0.75rem; width: 100%; margin-top: 0.5rem; margin-bottom: 1rem; transition: background-color 0.2s; cursor: pointer; text-align: center; border: none; }
        .see-whats-included-btn:hover { background-color: #dbeafe; }
        .feature-dropdown { display: none; overflow: hidden; transition: max-height 0.3s ease-out; max-height: 0; padding-bottom: 1rem; }
        .feature-dropdown.show { max-height: 1000px; display: block; }

        .time-button { padding: 0.75rem 1rem; border-radius: 0.75rem; border: 2px solid #cbd5e1; font-weight: 500; cursor: pointer; transition: all 0.2s ease; background-color: #e0f2fe; color: #1e40af; text-align: center; }
        .time-button:hover:not(:disabled) { background-color: #bfdbfe; border-color: #60a5fa; }
        .time-button.selected { background-color: #2563eb; color: white; border-color: #2563eb; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .time-button:disabled { background-color: #e2e8f0; color: #94a3b8; cursor: not-allowed; opacity: 0.7; }

        input, select { width: 100%; padding: 0.75rem 1rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; background-color: #ffffff; font-size: 1rem; color: #334155; transition: border-color 0.2s, box-shadow 0.2s; }
        input:focus, select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
        label { display: block; font-weight: 500; margin-bottom: 0.5rem; color: #475569; }

        .password-requirement { font-size: 0.875rem; color: #64748b; }
        .password-requirement.valid { color: #16a34a; }
        .password-requirement.invalid { color: #dc2626; }

        #booking-flow-container { display: none; }
        
        .sticky-book-now-footer { position: fixed; bottom: 0; left: 0; width: 100%; background-color: #ffffff; box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1); padding: 1rem; text-align: center; z-index: 1000; }
        .sticky-book-now-footer .btn-success { font-size: 1.25rem; padding: 1rem 2.5rem; border-radius: 9999px; box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2); }
    </style>
</head>
<body class="bg-gray-50">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-4xl">
        <header class="text-center mb-10">
            <img src="https://michieauto.com/logo.jpeg" alt="Michie Auto Detailing Logo" class="mx-auto mb-4 w-64 h-auto rounded-lg shadow-md">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">Book Your Auto Detail</h1>
            <p class="text-lg text-gray-600">It only takes 2 minutes!</p>
        </header>

        <section class="bg-white p-8 rounded-xl shadow-lg mb-8">
            <h2 class="text-3xl font-bold text-gray-700 mb-6 text-center">Why Choose Michie Auto Detailing?</h2>
            <p class="text-lg text-gray-600 text-center mb-8 max-w-2xl mx-auto">
                We bring the showroom shine directly to your doorstep, offering unparalleled convenience and meticulous attention to detail. Our expert team uses only premium products to ensure your vehicle looks its absolute best.
            </p>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
                <img src="https://res.cloudinary.com/dvrljjtdr/image/upload/v1751503250/IMG_20250702_124111_h4edvd.jpg" alt="Detailed car interior" class="w-full h-48 object-cover rounded-lg shadow-md" onerror="this.onerror=null;this.src='https://placehold.co/400x300/cccccc/ffffff?text=Image+1'">
                <img src="https://res.cloudinary.com/dvrljjtdr/image/upload/v1751502419/IMG_20250702_124112_uzh5mb.jpg" alt="Car exterior detailing" class="w-full h-48 object-cover rounded-lg shadow-md" onerror="this.onerror=null;this.src='https://placehold.co/400x300/cccccc/ffffff?text=Image+2'">
                <img src="https://res.cloudinary.com/dvrljjtdr/image/upload/v1751502419/IMG_20250702_124047_mmybkw.jpg" alt="Clean car seats" class="w-full h-48 object-cover rounded-lg shadow-md" onerror="this.onerror=null;this.src='https://placehold.co/400x300/cccccc/ffffff?text=Image+3'">
            </div>
        </section>

        <div id="booking-flow-container" class="bg-white p-8 rounded-xl shadow-lg space-y-8">
            <!-- Step 1: Vehicle Type Selection -->
            <div id="vehicle-type-selection">
                <h2 class="text-2xl font-bold text-gray-700 mb-6 text-center">1. Select Your Vehicle Type</h2>
                <div class="flex flex-wrap justify-center gap-4">
                    <button id="select-car-type" class="btn-primary">Car</button>
                    <button id="select-truck-type" class="btn-primary">Truck</button>
                    <button id="select-suv-type" class="btn-primary">SUV</button>
                </div>
            </div>

            <!-- Step 2: Package Selection -->
            <div id="package-selection-container" class="hidden">
                <h2 class="text-2xl font-bold text-gray-700 mb-8 text-center">2. Choose Your Detail Package</h2>
                <div id="sedan-packages-display" class="pricing-grid hidden">
                    <!-- Sedan Package Cards -->
                    <div class="pricing-card">
                        <h4 class="pricing-level">Level 1 Detail</h4>
                        <p class="pricing-price">$149</p>
                        <button class="see-whats-included-btn" data-target="sedan-level1-features">See what's included</button>
                        <div id="sedan-level1-features" class="feature-dropdown">
                            <ul class="feature-list">
                                <li>External high pressure wash</li>
                                <li>Tire cleaner</li>
                                <li>Window cleaning inside and out</li>
                                <li>Deep vaccuming</li>
                                <li>Display controls and panels wipedown</li>
                                <li>Mirror cleaning</li>
                                <li>Seat vaccum</li>
                                <li>Surface protectent for the dash and display/controls</li>
                                <li>Steering wheel and dash clean</li>
                            </ul>
                        </div>
                        <button class="select-package-btn btn-success" data-package-type="Level 1 Detail" data-package-price="149">Select Package</button>
                    </div>
                    <div class="pricing-card">
                        <h4 class="pricing-level">Level 2 Detail</h4>
                        <p class="pricing-price">$249</p>
                        <button class="see-whats-included-btn" data-target="sedan-level2-features">See what's included</button>
                        <div id="sedan-level2-features" class="feature-dropdown">
                            <ul class="feature-list">
                                <li>External high pressure wash</li>
                                <li>Tire cleaner</li>
                                <li>Window cleaning inside and out</li>
                                <li>Deep vaccuming</li>
                                <li>Display controls and panels wipedown</li>
                                <li>Mirror cleaning</li>
                                <li>Seat vaccum</li>
                                <li>Surface protectent for the dash and display/controls</li>
                                <li>Steering wheel and dash clean</li>
                                <li>Shampoo carpets and seats</li>
                                <li>Premium Leather treatment</li>
                                <li>Door jam cleaning</li>
                                <li>Rims and tires cleaned and wiped down</li>
                                <li>Console scrub down</li>
                                <li>Pet hair removal</li>
                                <li>Odor removal</li>
                            </ul>
                        </div>
                        <button class="select-package-btn btn-success" data-package-type="Level 2 Detail" data-package-price="249">Select Package</button>
                    </div>
                    <div class="pricing-card">
                        <h4 class="pricing-level">Level 3 Detail</h4>
                        <p class="pricing-price">$349</p>
                        <button class="see-whats-included-btn" data-target="sedan-level3-features">See what's included</button>
                        <div id="sedan-level3-features" class="feature-dropdown">
                            <ul class="feature-list">
                                <li>External high pressure wash</li>
                                <li>Tire cleaner</li>
                                <li>Window cleaning inside and out</li>
                                <li>Deep vaccuming</li>
                                <li>Display controls and panels wipedown</li>
                                <li>Mirror cleaning</li>
                                <li>Seat vaccum</li>
                                <li>Surface protectent for the dash and display/controls</li>
                                <li>Steering wheel and dash clean</li>
                                <li>Shampoo carpets and seats</li>
                                <li>Premium Leather treatment</li>
                                <li>Door jam cleaning</li>
                                <li>Rims and tires cleaned and wiped down</li>
                                <li>Console scrub down</li>
                                <li>Pet hair removal</li>
                                <li>Odor removal</li>
                                <li>FINE TOOTH COMB in between seats cleaning</li>
                                <li>Glove compartment cleaning</li>
                                <li>Trunk shampoo and vaccum</li>
                                <li>Door controls cleaning</li>
                                <li>Hard to reach areas deep level shampoo</li>
                                <li>Meticulous cleaning of all frequently touched surfaces</li>
                                <li>External bug removal</li>
                                <li>Free microfiber cloth</li>
                                <li>Protection plan (complimentary maintenance clean within 15 days)</li>
                            </ul>
                        </div>
                        <button class="select-package-btn btn-success" data-package-type="Level 3 Detail" data-package-price="349">Select Package</button>
                    </div>
                </div>
                <div id="suv-truck-packages-display" class="pricing-grid hidden">
                    <!-- SUV/Truck Package Cards -->
                    <div class="pricing-card">
                        <h4 class="pricing-level">Level 1 Detail</h4>
                        <p class="pricing-price">$199</p>
                        <button class="see-whats-included-btn" data-target="suv-truck-level1-features">See what's included</button>
                        <div id="suv-truck-level1-features" class="feature-dropdown">
                            <ul class="feature-list">
                                <li>External high pressure wash</li>
                                <li>Tire cleaner</li>
                                <li>Window cleaning inside and out</li>
                                <li>Deep vaccuming</li>
                                <li>Display controls and panels wipedown</li>
                                <li>Mirror cleaning</li>
                                <li>Seat vaccum</li>
                                <li>Surface protectent for the dash and display/controls</li>
                                <li>Steering wheel and dash clean</li>
                            </ul>
                        </div>
                        <button class="select-package-btn btn-success" data-package-type="Level 1 Detail" data-package-price="199">Select Package</button>
                    </div>
                    <div class="pricing-card">
                        <h4 class="pricing-level">Level 2 Detail</h4>
                        <p class="pricing-price">$299</p>
                        <button class="see-whats-included-btn" data-target="suv-truck-level2-features">See what's included</button>
                        <div id="suv-truck-level2-features" class="feature-dropdown">
                            <ul class="feature-list">
                                <li>External high pressure wash</li>
                                <li>Tire cleaner</li>
                                <li>Window cleaning inside and out</li>
                                <li>Deep vaccuming</li>
                                <li>Display controls and panels wipedown</li>
                                <li>Mirror cleaning</li>
                                <li>Seat vaccum</li>
                                <li>Surface protectent for the dash and display/controls</li>
                                <li>Steering wheel and dash clean</li>
                                <li>Shampoo carpets and seats</li>
                                <li>Premium Leather treatment</li>
                                <li>Door jam cleaning</li>
                                <li>Rims and tires cleaned and wiped down</li>
                                <li>Console scrub down</li>
                                <li>Pet hair removal</li>
                                <li>Odor removal</li>
                            </ul>
                        </div>
                        <button class="select-package-btn btn-success" data-package-type="Level 2 Detail" data-package-price="299">Select Package</button>
                    </div>
                    <div class="pricing-card">
                        <h4 class="pricing-level">Level 3 Detail</h4>
                        <p class="pricing-price">$399</p>
                        <button class="see-whats-included-btn" data-target="suv-truck-level3-features">See what's included</button>
                        <div id="suv-truck-level3-features" class="feature-dropdown">
                            <ul class="feature-list">
                                <li>External high pressure wash</li>
                                <li>Tire cleaner</li>
                                <li>Window cleaning inside and out</li>
                                <li>Deep vaccuming</li>
                                <li>Display controls and panels wipedown</li>
                                <li>Mirror cleaning</li>
                                <li>Seat vaccum</li>
                                <li>Surface protectent for the dash and display/controls</li>
                                <li>Steering wheel and dash clean</li>
                                <li>Shampoo carpets and seats</li>
                                <li>Premium Leather treatment</li>
                                <li>Door jam cleaning</li>
                                <li>Rims and tires cleaned and wiped down</li>
                                <li>Console scrub down</li>
                                <li>Pet hair removal</li>
                                <li>Odor removal</li>
                                <li>FINE TOOTH COMB in between seats cleaning</li>
                                <li>Glove compartment cleaning</li>
                                <li>Trunk shampoo and vaccum</li>
                                <li>Door controls cleaning</li>
                                <li>Hard to reach areas deep level shampoo</li>
                                <li>Meticulous cleaning of all frequently touched surfaces</li>
                                <li>External bug removal</li>
                                <li>Free microfiber cloth</li>
                                <li>Protection plan (complimentary maintenance clean within 15 days)</li>
                            </ul>
                        </div>
                        <button class="select-package-btn btn-success" data-package-type="Level 3 Detail" data-package-price="399">Select Package</button>
                    </div>
                </div>
            </div>

            <!-- Step 3: Main Booking Form -->
            <div id="booking-form-section" class="hidden">
                <h2 class="text-2xl font-bold text-gray-700 mb-4">3. Your Information & Appointment Details</h2>
                <p class="text-lg font-semibold text-gray-800 mb-4">Selected Package: <span id="selected-package-display" class="text-blue-600"></span></p>
                <form id="booking-form" class="space-y-6">
                    <div>
                        <label for="full-name">Full Name</label>
                        <input type="text" id="full-name" placeholder="Your Full Name" required>
                    </div>
                    <div>
                        <label for="email">Email Address</label>
                        <input type="email" id="email" placeholder="Your Email Address" required>
                    </div>
                    <div>
                        <label for="phone">Phone Number</label>
                        <input type="tel" id="phone" placeholder="Your Phone Number" required>
                    </div>
                    <div>
                        <label for="address-input">Service Address</label>
                        <input type="text" id="address-input" placeholder="Start typing your address..." required>
                    </div>
                    <div>
                        <label for="zip-code">Zip Code</label>
                        <input type="text" id="zip-code" placeholder="Your Zip Code" required>
                    </div>
                    <div>
                        <label for="vehicle-year">Vehicle Year</label>
                        <input type="text" id="vehicle-year" placeholder="e.g., 2020" required>
                    </div>
                    <div>
                        <label for="vehicle-make">Vehicle Make</label>
                        <select id="vehicle-make" required>
                            <option value="">Select Make</option>
                            <option value="Acura">Acura</option>
                            <option value="Audi">Audi</option>
                            <option value="BMW">BMW</option>
                            <option value="Buick">Buick</option>
                            <option value="Cadillac">Cadillac</option>
                            <option value="Chevrolet">Chevrolet</option>
                            <option value="Chrysler">Chrysler</option>
                            <option value="Dodge">Dodge</option>
                            <option value="Ford">Ford</option>
                            <option value="GMC">GMC</option>
                            <option value="Honda">Honda</option>
                            <option value="Hyundai">Hyundai</option>
                            <option value="Infiniti">Infiniti</option>
                            <option value="Jaguar">Jaguar</option>
                            <option value="Jeep">Jeep</option>
                            <option value="Kia">Kia</option>
                            <option value="Land Rover">Land Rover</option>
                            <option value="Lexus">Lexus</option>
                            <option value="Lincoln">Lincoln</option>
                            <option value="Mazda">Mazda</option>
                            <option value="Mercedes-Benz">Mercedes-Benz</option>
                            <option value="Mini">Mini</option>
                            <option value="Mitsubishi">Mitsubishi</option>
                            <option value="Nissan">Nissan</option>
                            <option value="Ram">Ram</option>
                            <option value="Subaru">Subaru</option>
                            <option value="Tesla">Tesla</option>
                            <option value="Toyota">Toyota</option>
                            <option value="Volkswagen">Volkswagen</option>
                            <option value="Volvo">Volvo</option>
                            <option value="Smart">Smart</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label for="vehicle-model">Vehicle Model</label>
                        <input type="text" id="vehicle-model" placeholder="e.g., Civic" required>
                    </div>

                    <div class="mt-4">
                        <label class="flex items-center space-x-2 cursor-pointer text-gray-700">
                            <input type="checkbox" id="create-account-checkbox" class="rounded h-4 w-4 text-blue-600 focus:ring-blue-500">
                            <span>Create an account (Optional)</span>
                        </label>
                    </div>

                    <div id="password-fields" class="space-y-4 hidden">
                        <div>
                            <label for="password">Password</label>
                            <input type="password" id="password" placeholder="Enter a password" autocomplete="new-password">
                            <div class="text-sm mt-1 pl-1 space-y-0.5">
                                <p id="password-length-req" class="password-requirement invalid">At least 6 characters</p>
                                <p id="password-uppercase-req" class="password-requirement invalid">At least 1 capital letter</p>
                            </div>
                        </div>
                        <div>
                            <label for="confirm-password">Confirm Password</label>
                            <input type="password" id="confirm-password" placeholder="Confirm your password">
                            <p id="password-match-message" class="text-sm text-red-600 mt-1 pl-1 hidden">Passwords do not match.</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="booking-date">Date</label>
                            <input type="date" id="booking-date" required>
                        </div>
                        <div>
                            <label for="selected-booking-time">Time</label>
                            <div id="booking-time-buttons" class="grid grid-cols-3 gap-2"></div>
                            <input type="hidden" id="selected-booking-time" name="booking-time" required>
                        </div>
                    </div>
                    <input type="hidden" id="selected-package-type" name="package-type">
                    <input type="hidden" id="selected-package-price" name="package-price">
                    <button type="submit" id="final-book-appointment-btn" class="w-full btn-success hidden">Book Appointment</button>
                    <p id="booking-message" class="text-center mt-2"></p>
                </form>
            </div>

            <!-- Confirmation Message -->
            <div id="confirmation-message" class="bg-green-100 border-l-4 border-green-500 text-green-700 p-6 rounded-lg text-center hidden">
                <p class="text-2xl font-bold mb-2">Thank you! Your booking is confirmed!</p>
                <p class="text-xl">Your total is: <span id="total-price-display" class="font-extrabold">$0</span></p>
                <p class="text-md mt-4">You will receive a confirmation email shortly.</p>
                <button id="pay-now-button" class="btn-success mt-6">Pay Now</button>
                <button id="book-another-btn" class="btn-primary mt-6 ml-4">Book Another Appointment</button>
            </div>

        </div>
    </div>

    <!-- Sticky Book Now Footer -->
    <div id="sticky-book-now-footer" class="sticky-book-now-footer">
        <button id="sticky-book-now-btn" class="btn-success">
            Book Your Detail Now!
        </button>
    </div>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB133ISKHPtat18iloHDlqm2QHBv133sOk&libraries=places&callback=initBookingPage" defer></script>
    <script>
        function initBookingPage() {
            const addressInput = document.getElementById('address-input');
            if (window.google && window.google.maps && window.google.maps.places && addressInput) {
                let addressAutocomplete = new google.maps.places.Autocomplete(addressInput, {
                    componentRestrictions: { country: "us" },
                    fields: ["formatted_address", "address_components"],
                    types: ["address"],
                });
                addressAutocomplete.addListener('place_changed', () => {
                    const place = addressAutocomplete.getPlace();
                    if (place.formatted_address) {
                        addressInput.value = place.formatted_address;
                        let zipCode = '';
                        for (const component of place.address_components) {
                            if (component.types.includes('postal_code')) {
                                zipCode = component.long_name;
                            }
                        }
                        document.getElementById('zip-code').value = zipCode;
                    }
                });
            } else {
                console.warn("Google Maps Autocomplete could not be initialized.");
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const API_BASE_URL = 'https://michie-detailing-admin.onrender.com';
            
            const elements = {
                bookingFlowContainer: document.getElementById('booking-flow-container'),
                vehicleTypeSelection: document.getElementById('vehicle-type-selection'),
                packageSelectionContainer: document.getElementById('package-selection-container'),
                sedanPackagesDisplay: document.getElementById('sedan-packages-display'), 
                suvTruckPackagesDisplay: document.getElementById('suv-truck-packages-display'), 
                bookingFormSection: document.getElementById('booking-form-section'),
                bookingForm: document.getElementById('booking-form'),
                selectedPackageDisplay: document.getElementById('selected-package-display'),
                selectedPackageTypeInput: document.getElementById('selected-package-type'),
                selectedPackagePriceInput: document.getElementById('selected-package-price'),
                finalBookAppointmentBtn: document.getElementById('final-book-appointment-btn'),
                confirmationMessage: document.getElementById('confirmation-message'),
                bookAnotherBtn: document.getElementById('book-another-btn'),
                stickyBookNowBtn: document.getElementById('sticky-book-now-btn'), 
                stickyBookNowFooter: document.getElementById('sticky-book-now-footer'), 
                totalPriceDisplay: document.getElementById('total-price-display'),
                payNowButton: document.getElementById('pay-now-button'),
                bookingDateInput: document.getElementById('booking-date'),
                bookingTimeButtonsContainer: document.getElementById('booking-time-buttons'),
                selectedBookingTimeInput: document.getElementById('selected-booking-time'),
                bookingMessage: document.getElementById('booking-message'),
                createAccountCheckbox: document.getElementById('create-account-checkbox'),
                passwordFields: document.getElementById('password-fields'),
                passwordInput: document.getElementById('password'),
                confirmPasswordInput: document.getElementById('confirm-password'),
                passwordLengthReq: document.getElementById('password-length-req'),
                passwordUppercaseReq: document.getElementById('password-uppercase-req'),
                passwordMatchMessage: document.getElementById('password-match-message')
            };

            const availableTimes = ['09:00:00', '11:00:00', '12:00:00', '14:00:00', '16:00:00', '17:00:00', '18:00:00'];

            const paymentLinks = {
                "Level 1 Detail": { "149": "https://pay.michieauto.com/lvl1sedan", "199": "https://pay.michieauto.com/lvl1suv" },
                "Level 2 Detail": { "249": "https://pay.michieauto.com/lvl2sedan", "299": "https://pay.michieauto.com/lvl2suv" },
                "Level 3 Detail": { "349": "https://pay.michieauto.com/lvl3sedan", "399": "https://pay.michieauto.com/lvl3suv" },
            };

            function hideAllMajorSections() {
                [elements.vehicleTypeSelection, elements.packageSelectionContainer, elements.bookingFormSection, elements.confirmationMessage]
                    .forEach(el => el.style.display = 'none');
            }

            function showInitialPage() {
                hideAllMajorSections();
                elements.vehicleTypeSelection.style.display = 'block';
                document.querySelectorAll('#vehicle-type-selection .btn-primary.active').forEach(b => b.classList.remove('active'));
            }

            function showBookingForm() { 
                hideAllMajorSections();
                elements.bookingFormSection.style.display = 'block';
                elements.stickyBookNowFooter.style.display = 'none';
            }

            elements.stickyBookNowBtn.addEventListener('click', () => {
                elements.bookingFlowContainer.style.display = 'block';
                elements.bookingFlowContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                showInitialPage(); 
            });

            document.querySelectorAll('#vehicle-type-selection .btn-primary').forEach(button => {
                button.addEventListener('click', (e) => {
                    let type = '';
                    if (e.target.id === 'select-car-type') type = 'sedan';
                    if (e.target.id === 'select-truck-type' || e.target.id === 'select-suv-type') type = 'suv-truck';
                    
                    showPackageSelection(type, e.target);
                    elements.packageSelectionContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                });
            });

            elements.bookingForm.addEventListener('submit', handleBooking);

            elements.bookAnotherBtn.addEventListener('click', () => {
                elements.bookingForm.reset();
                elements.createAccountCheckbox.checked = false;
                elements.passwordFields.style.display = 'none';
                elements.passwordInput.value = '';
                elements.confirmPasswordInput.value = '';
                elements.passwordMatchMessage.classList.add('hidden');
                elements.bookingMessage.textContent = '';
                elements.stickyBookNowFooter.style.display = 'block'; 
                showInitialPage();
            });

            elements.bookingDateInput.addEventListener('change', (e) => renderTimeButtons(e.target.value));

            elements.packageSelectionContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('select-package-btn')) {
                    const packageType = e.target.dataset.packageType;
                    const packagePrice = e.target.dataset.packagePrice;
                    handlePackageSelection(packageType, packagePrice);
                    elements.bookingFormSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                } else if (e.target.classList.contains('see-whats-included-btn')) {
                    const targetId = e.target.dataset.target;
                    const dropdown = document.getElementById(targetId);
                    if (dropdown) {
                        dropdown.classList.toggle('show');
                        e.target.textContent = dropdown.classList.contains('show') ? 'Hide details' : "See what's included";
                    }
                }
            });

            elements.createAccountCheckbox.addEventListener('change', () => {
                elements.passwordFields.style.display = elements.createAccountCheckbox.checked ? 'block' : 'none';
                if (!elements.createAccountCheckbox.checked) {
                    elements.passwordInput.value = '';
                    elements.confirmPasswordInput.value = '';
                }
            });

            elements.passwordInput.addEventListener('input', validatePassword);
            elements.confirmPasswordInput.addEventListener('input', checkPasswordsMatch);

            function showPackageSelection(vehicleCategory, clickedButton) {
                hideAllMajorSections();
                elements.packageSelectionContainer.style.display = 'block';
                document.querySelectorAll('#vehicle-type-selection .btn-primary.active').forEach(b => b.classList.remove('active'));
                clickedButton.classList.add('active');
                elements.sedanPackagesDisplay.style.display = vehicleCategory === 'sedan' ? 'grid' : 'none';
                elements.suvTruckPackagesDisplay.style.display = vehicleCategory === 'suv-truck' ? 'grid' : 'none';
                elements.stickyBookNowFooter.style.display = 'none';
            }

            function handlePackageSelection(packageType, packagePrice) {
                elements.selectedPackageDisplay.textContent = packageType;
                elements.selectedPackageTypeInput.value = packageType;
                elements.selectedPackagePriceInput.value = packagePrice;
                showBookingForm(); 
                const todayFormatted = new Date().toISOString().split('T')[0];
                elements.bookingDateInput.value = todayFormatted;
                renderTimeButtons(todayFormatted);
            }

            async function handleBooking(e) { 
                e.preventDefault();
                elements.bookingMessage.textContent = '';

                const selectedTime = elements.selectedBookingTimeInput.value;
                if (!selectedTime) {
                    elements.bookingMessage.textContent = 'Please select an appointment time.';
                    elements.bookingMessage.style.color = 'red';
                    return;
                }

                const createAccount = elements.createAccountCheckbox.checked;
                if (createAccount && (!validatePassword() || !checkPasswordsMatch())) {
                    elements.bookingMessage.textContent = 'Please fix password errors.';
                    elements.bookingMessage.style.color = 'red';
                    return;
                }

                const payload = {
                    full_name: document.getElementById('full-name').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('phone').value,
                    address: document.getElementById('address-input').value,
                    zip_code: document.getElementById('zip-code').value,
                    vehicle_year: document.getElementById('vehicle-year').value,
                    vehicle_make: document.getElementById('vehicle-make').value,
                    vehicle_model: document.getElementById('vehicle-model').value,
                    date: elements.bookingDateInput.value,
                    time: selectedTime,
                    package_type: elements.selectedPackageTypeInput.value,
                    package_price: elements.selectedPackagePriceInput.value,
                    deal_name: `${elements.selectedPackageTypeInput.value} ${document.getElementById('vehicle-make').value} ${document.getElementById('vehicle-model').value}`,
                    offer_code: "CONNOR2438",
                    create_account: createAccount,
                    password: createAccount ? elements.passwordInput.value : ''
                };

                try {
                    const response = await fetch(`${API_BASE_URL}/public/appointment`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const data = await response.json();
                    if (response.ok) {
                        hideAllMajorSections();
                        elements.confirmationMessage.style.display = 'block';
                        elements.totalPriceDisplay.textContent = `$${parseFloat(payload.package_price).toFixed(2)}`;
                        const priceKey = String(payload.package_price);
                        let paymentRedirectLink = '#';
                        if (paymentLinks[payload.package_type] && paymentLinks[payload.package_type][priceKey]) {
                            paymentRedirectLink = paymentLinks[payload.package_type][priceKey];
                        }
                        elements.payNowButton.onclick = () => { window.open(paymentRedirectLink, '_blank'); };
                        elements.stickyBookNowFooter.style.display = 'none';
                    } else {
                        elements.bookingMessage.textContent = data.message || 'An error occurred during booking.';
                        elements.bookingMessage.style.color = 'red';
                    }
                } catch (error) {
                    elements.bookingMessage.textContent = 'Network error. Please try again.';
                    elements.bookingMessage.style.color = 'red';
                }
            }
            
            function renderTimeButtons(selectedDate) {
                const container = elements.bookingTimeButtonsContainer;
                const hiddenInput = elements.selectedBookingTimeInput;
                const finalBookButton = elements.finalBookAppointmentBtn;

                container.innerHTML = '';
                
                const now = new Date();
                const todayCST = now.toLocaleDateString('en-CA', { timeZone: 'America/Chicago' });
                const selectedDateCST = new Date(selectedDate + 'T12:00:00Z').toLocaleDateString('en-CA', { timeZone: 'America/Chicago' });
                const isToday = (todayCST === selectedDateCST);

                const currentCSTHour = parseInt(now.toLocaleString('en-US', { hour: '2-digit', hourCycle: 'h23', timeZone: 'America/Chicago' }));
                const currentCSTMinute = parseInt(now.toLocaleString('en-US', { minute: '2-digit', timeZone: 'America/Chicago' }));

                availableTimes.forEach(time => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.textContent = formatTimeDisplay(time);
                    button.dataset.time = time;
                    let isDisabled = false;
                    
                    if (isToday) {
                        const [appointmentHour] = time.split(':').map(Number);
                        const currentTotalMinutes = (currentCSTHour * 60) + currentCSTMinute;
                        const appointmentTotalMinutes = (appointmentHour * 60);
                        if ((appointmentTotalMinutes - currentTotalMinutes) < 120) {
                            isDisabled = true;
                        }
                    }

                    if (isDisabled) {
                        button.className = 'time-button disabled';
                        button.disabled = true;
                    } else {
                        button.className = 'time-button';
                        button.addEventListener('click', () => {
                            const currentlySelected = container.querySelector('.time-button.selected');
                            if (currentlySelected) currentlySelected.classList.remove('selected');
                            button.classList.add('selected');
                            hiddenInput.value = time;
                            finalBookButton.style.display = 'block';
                        });
                    }
                    container.appendChild(button);
                });
                hiddenInput.value = '';
                finalBookButton.style.display = 'none';
            }

            function formatTimeDisplay(time24hr) {
                const [hours] = time24hr.split(':').map(Number);
                const date = new Date();
                date.setHours(hours, 0);
                return date.toLocaleString('en-US', { hour: 'numeric', hour12: true });
            }
            
            function validatePassword() {
                const password = elements.passwordInput.value;
                const isLengthValid = password.length >= 6;
                const hasUppercase = /[A-Z]/.test(password);
                elements.passwordLengthReq.classList.toggle('valid', isLengthValid);
                elements.passwordLengthReq.classList.toggle('invalid', !isLengthValid);
                elements.passwordUppercaseReq.classList.toggle('valid', hasUppercase);
                elements.passwordUppercaseReq.classList.toggle('invalid', !hasUppercase);
                return isLengthValid && hasUppercase;
            }

            function checkPasswordsMatch() {
                const password = elements.passwordInput.value;
                const confirmPassword = elements.confirmPasswordInput.value;
                elements.passwordMatchMessage.classList.toggle('hidden', password === confirmPassword);
                return password === confirmPassword;
            }
            
            const todayFormatted = new Date().toISOString().split('T')[0];
            elements.bookingDateInput.value = todayFormatted;
            elements.bookingDateInput.min = todayFormatted;
            renderTimeButtons(todayFormatted);
        });
    </script>
</body>
</html>
