<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Michie Auto Detailing - Sign Up</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .container {
            max-width: 500px;
        }
        .form-input {
            @apply w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500;
        }
        .btn-primary {
            @apply w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition duration-300;
        }
        .message-box {
            @apply p-3 mt-4 rounded-md text-sm;
        }
        .message-box.success {
            @apply bg-green-100 text-green-700;
        }
        .message-box.error {
            @apply bg-red-100 text-red-700;
        }
        /* The Autocomplete Element handles its own styling for the dropdown,
           but these might be useful for general input styling or fallbacks. */
        gmp-places-autocomplete {
            width: 100%; /* Ensure the web component takes full width */
            --gmp-places-autocomplete-border-radius: 0.375rem; /* Tailwind's rounded-md */
            --gmp-places-autocomplete-border-color: #D1D5DB; /* Tailwind's gray-300 */
            --gmp-places-autocomplete-focus-ring-color: #3B82F6; /* Tailwind's blue-500 */
            --gmp-places-autocomplete-focus-ring-width: 2px;
            --gmp-places-autocomplete-padding: 0.5rem 1rem; /* Tailwind's py-2 px-4 */
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">
    <div class="container bg-white p-8 rounded-lg shadow-lg">
        <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Sign Up for Michie Auto Detailing</h2>

        <form id="signupForm" class="space-y-4">
            <div>
                <label for="fullName" class="block text-gray-700 text-sm font-semibold mb-2">Full Name</label>
                <input type="text" id="fullName" name="fullName" class="form-input" required>
            </div>
            <div>
                <label for="email" class="block text-gray-700 text-sm font-semibold mb-2">Email</label>
                <input type="email" id="email" name="email" class="form-input" required>
            </div>
            <div>
                <label for="phone" class="block text-gray-700 text-sm font-semibold mb-2">Phone Number</label>
                <input type="tel" id="phone" name="phone" class="form-input" required>
            </div>
            <div>
                <label for="address" class="block text-gray-700 text-sm font-semibold mb-2">Service Address</label>
                <!-- The actual input field that the Autocomplete Element will enhance -->
                <input type="text" id="address" name="address" class="form-input" required>
                <!-- The new Autocomplete Element, linked to the input by its ID -->
                <gmp-places-autocomplete for-input="address" country="us" types="address"></gmp-places-autocomplete>

                <input type="hidden" id="streetNumber" name="streetNumber">
                <input type="hidden" id="streetName" name="streetName">
                <input type="hidden" id="city" name="city">
                <input type="hidden" id="state" name="state">
                <input type="hidden" id="zipCode" name="zipCode">
                <input type="hidden" id="country" name="country">
                <div id="address-validation-message" class="text-sm text-red-600 mt-1 hidden">Please select a valid address from the suggestions.</div>
            </div>
            <div>
                <label for="password" class="block text-gray-700 text-sm font-semibold mb-2">Password</label>
                <input type="password" id="password" name="password" class="form-input" required minlength="6">
            </div>
            <div>
                <label for="confirmPassword" class="block text-gray-700 text-sm font-semibold mb-2">Confirm Password</label>
                <input type="password" id="confirmPassword" name="confirmPassword" class="form-input" required minlength="6">
            </div>
            <button type="submit" class="btn-primary">Sign Up</button>
        </form>

        <div id="messageBox" class="message-box hidden"></div>
    </div>

    <!-- Google Maps Places API (New) - Load the 'places' library -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB133ISKHPtat18iloHDlqm2QHBv133sOk&libraries=places&callback=initMap" async defer></script>

    <script>
        // Backend API URL - IMPORTANT: Replace with your actual deployed backend URL
        const BACKEND_API_URL = "http://127.0.0.1:5001"; // Or your deployed Render URL: https://michie-detailing-admin.onrender.com

        let addressComponents = {}; // To store parsed address details from the selected place

        /**
         * Initializes the Google Maps Places Autocomplete Element.
         * This function is called once the Google Maps API script has loaded.
         */
        function initMap() {
            // Select the Autocomplete Element web component
            const autocompleteElement = document.querySelector("gmp-places-autocomplete");

            // Add an event listener for the 'gmp-placeselect' event,
            // which fires when a user selects a place from the suggestions.
            autocompleteElement.addEventListener("gmp-placeselect", (event) => {
                // The selected place details are available in event.detail.place
                fillInAddress(event.detail.place);
            });
        }

        /**
         * Extracts and stores the address components from the selected place object.
         * Updates hidden input fields and the visible address input.
         * @param {object} place - The place object returned by the Autocomplete Element.
         */
        function fillInAddress(place) {
            addressComponents = {}; // Reset components for a new selection

            // Check if address components are available in the place object
            // The new API uses 'addressComponents' (camelCase) instead of 'address_components'
            if (!place.addressComponents) {
                document.getElementById("address-validation-message").classList.remove("hidden");
                return;
            }

            document.getElementById("address-validation-message").classList.add("hidden");

            // Iterate through the address components provided by the Google Place object
            for (const component of place.addressComponents) {
                const componentType = component.types[0]; // Get the primary type of the component

                // Map Google's component types to our desired address fields
                switch (componentType) {
                    case "street_number":
                        addressComponents.streetNumber = component.longText; // Full text for street number
                        break;
                    case "route":
                        addressComponents.streetName = component.longText; // Full text for street name
                        break;
                    case "locality":
                        addressComponents.city = component.longText; // Full text for city
                        break;
                    case "administrative_area_level_1":
                        addressComponents.state = component.shortText; // Abbreviated text for state (e.g., "CA")
                        break;
                    case "postal_code":
                        addressComponents.zipCode = component.longText; // Full text for zip code
                        break;
                    case "country":
                        addressComponents.country = component.shortText; // Abbreviated text for country (e.g., "US")
                        break;
                }
            }

            // Update the values of the hidden input fields with the parsed components
            document.getElementById("streetNumber").value = addressComponents.streetNumber || '';
            document.getElementById("streetName").value = addressComponents.streetName || '';
            document.getElementById("city").value = addressComponents.city || '';
            document.getElementById("state").value = addressComponents.state || '';
            document.getElementById("zipCode").value = addressComponents.zipCode || '';
            document.getElementById("country").value = addressComponents.country || '';

            // The Autocomplete Element automatically updates the visible input field
            // with the formatted address. We also explicitly set it here for clarity
            // and to ensure our form data is consistent.
            document.getElementById("address").value = place.formattedAddress || '';
        }

        /**
         * Displays a message in a dedicated message box on the page.
         * @param {string} message - The text message to display.
         * @param {string} type - The type of message ('success' or 'error') to apply styling.
         */
        function showMessage(message, type) {
            const messageBox = document.getElementById("messageBox");
            messageBox.textContent = message;
            messageBox.classList.remove("hidden", "success", "error"); // Clear previous states
            messageBox.classList.add(type); // Add the new type for styling
        }

        // Event listener for the form submission
        document.getElementById("signupForm").addEventListener("submit", async function(event) {
            event.preventDefault(); // Prevent the default form submission behavior

            // Get values from form inputs
            const fullName = document.getElementById("fullName").value.trim();
            const email = document.getElementById("email").value.trim();
            const phone = document.getElementById("phone").value.trim();
            const address = document.getElementById("address").value.trim(); // This will contain the formatted address from the Autocomplete Element
            const password = document.getElementById("password").value;
            const confirmPassword = document.getElementById("confirmPassword").value;

            // Client-side validation checks
            if (!fullName || !email || !phone || !address || !password || !confirmPassword) {
                showMessage("Please fill in all fields.", "error");
                return;
            }

            if (password.length < 6) {
                showMessage("Password must be at least 6 characters long.", "error");
                return;
            }

            if (password !== confirmPassword) {
                showMessage("Passwords do not match.", "error");
                return;
            }

            // Validate if a valid address was selected using the Autocomplete Element
            // We check if the `addressComponents` object was populated by `fillInAddress`
            if (!addressComponents.streetNumber || !addressComponents.streetName || !addressComponents.city || !addressComponents.state || !addressComponents.zipCode) {
                document.getElementById("address-validation-message").classList.remove("hidden");
                showMessage("Please select a valid address from the suggestions.", "error");
                return;
            } else {
                document.getElementById("address-validation-message").classList.add("hidden");
            }

            // Construct the full address string to send to the backend.
            // This ensures a consistent format regardless of how Google's `formattedAddress` might vary.
            const fullAddress = `${addressComponents.streetNumber || ''} ${addressComponents.streetName || ''}, ${addressComponents.city || ''}, ${addressComponents.state || ''} ${addressComponents.zipCode || ''}, ${addressComponents.country || ''}`
                                .trim()
                                .replace(/,(\s*,)+/g, ',') // Replace multiple commas with a single one
                                .replace(/^,|,$/g, '') // Remove leading/trailing commas
                                .replace(/\s+,/g, ','); // Remove space before a comma

            try {
                // Send the signup data to your backend API
                const response = await fetch(`${BACKEND_API_URL}/customer/signup`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        full_name: fullName,
                        email: email,
                        phone: phone,
                        address: fullAddress, // Send the validated and formatted address
                        password: password,
                    }),
                });

                const data = await response.json(); // Parse the JSON response from the backend

                if (response.ok) {
                    showMessage(data.message, "success"); // Show success message
                    document.getElementById("signupForm").reset(); // Clear the form fields
                    addressComponents = {}; // Reset stored address components
                } else {
                    showMessage(data.message || "An error occurred during signup.", "error"); // Show error message
                }
            } catch (error) {
                console.error("Error during signup:", error);
                showMessage("Network error. Please try again later.", "error"); // Handle network errors
            }
        });
    </script>
</body>
</html>
