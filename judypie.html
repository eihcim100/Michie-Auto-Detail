<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Michie Auto Detailing - Call Center Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Light background */
            color: #334155; /* Darker text for contrast */
            padding-bottom: 2rem; /* Some space at the bottom */
        }
        .pac-container { z-index: 1050 !important; } /* Ensure Google Autocomplete is above other elements */

        /* General button styling for a light, stylish look */
        .btn-primary {
            background-color: #3b82f6; /* Blue-500 */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: none;
        }
        .btn-primary:hover {
            background-color: #2563eb; /* Blue-600 */
            transform: translateY(-2px);
            box-shadow: 0 6px 10px -1px rgba(0, 0, 0, 0.15), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
        }
        .btn-secondary {
            background-color: #e2e8f0; /* Gray-200 */
            color: #475569; /* Gray-700 */
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid #cbd5e1; /* Gray-300 */
        }
        .btn-secondary:hover {
            background-color: #cbd5e1; /* Gray-300 */
            transform: translateY(-1px);
        }
        .btn-success {
            background-color: #22c55e; /* Green-500 */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn-success:hover:not(:disabled) {
            background-color: #16a34a; /* Green-600 */
            transform: translateY(-2px);
            box-shadow: 0 6px 10px -1px rgba(0, 0, 0, 0.15), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
        }
        .btn-success:disabled {
            background-color: #16a34a;
            opacity: 0.7;
            cursor: not-allowed;
        }

        /* Package card styles - adapted for this page */
        .pricing-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
            justify-content: center;
            align-items: stretch;
        }
        @media (min-width: 768px) {
            .pricing-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        .pricing-card {
            background-color: #ffffff;
            border: 1px solid #e2e8f0; /* Light gray border */
            border-radius: 1rem; /* More rounded corners */
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05); /* Softer shadow */
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            height: 100%;
        }
        .pricing-card:hover {
            transform: translateY(-8px); /* More pronounced lift */
            box-shadow: 0 15px 30px rgba(0, 123, 255, 0.1); /* Softer blue shadow on hover */
        }
        .pricing-level {
            font-size: 1.5rem; /* Larger title */
            font-weight: 700; /* Semibold */
            color: #1e293b; /* Darker text */
            margin-bottom: 0.75rem;
        }
        .pricing-price {
            font-size: 2.5rem; /* Larger price */
            font-weight: 800; /* Extra bold */
            color: #059669; /* Green-600 */
            margin-bottom: 1.5rem;
        }
        .feature-list {
            list-style: none;
            padding: 0;
            text-align: left;
            flex-grow: 1;
            margin-bottom: 1.5rem;
        }
        .feature-list li {
            position: relative;
            padding-left: 2rem; /* More space for checkmark */
            margin-bottom: 0.8rem; /* More line spacing */
            color: #475569; /* Gray-700 */
            font-size: 0.95rem;
        }
        .feature-list li::before {
            content: '✓';
            color: #059669; /* Green checkmark */
            position: absolute;
            left: 0;
            font-weight: bold;
            font-size: 1.2rem;
        }
        .select-package-btn {
            width: 100%;
            margin-top: auto; /* Push button to bottom */
        }
        .see-whats-included-btn {
            background-color: #eff6ff; /* Blue-50 */
            color: #1e40af; /* Blue-800 */
            font-weight: 500;
            padding: 0.6rem 1.2rem;
            border-radius: 0.75rem;
            width: 100%;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
            transition: background-color 0.2s;
            cursor: pointer;
            text-align: center;
            border: none;
        }
        .see-whats-included-btn:hover { background-color: #dbeafe; } /* Blue-100 */
        .feature-dropdown {
            display: none;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            max-height: 0;
            padding-bottom: 1rem;
        }
        .feature-dropdown.show {
            max-height: 1000px; /* Arbitrarily large to show content */
            display: block;
        }

        /* Time slot buttons */
        .time-button {
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            border: 2px solid #cbd5e1; /* Gray-300 */
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: #e0f2fe; /* Light Blue-100 */
            color: #1e40af; /* Dark Blue-800 */
            text-align: center;
        }
        .time-button:hover:not(:disabled) {
            background-color: #bfdbfe; /* Blue-200 */
            border-color: #60a5fa; /* Blue-400 */
        }
        .time-button.selected {
            background-color: #2563eb; /* Blue-600 */
            color: white;
            border-color: #2563eb;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .time-button:disabled {
            background-color: #e2e8f0; /* Gray-200 */
            color: #94a3b8; /* Gray-400 */
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* Form input styling */
        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="date"],
        input[type="password"], /* Added password input styling */
        select,
        textarea { /* Added textarea styling */
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #cbd5e1;
            border-radius: 0.5rem;
            background-color: #ffffff;
            font-size: 1rem;
            color: #334155;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="tel"]:focus,
        input[type="date"]:focus,
        input[type="password"]:focus, /* Added password input focus styling */
        select:focus,
        textarea:focus { /* Added textarea focus styling */
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: #475569;
        }

        /* Password requirements styling */
        .password-requirement {
            font-size: 0.875rem; /* text-sm */
            color: #64748b; /* slate-500 */
        }
        .password-requirement.valid {
            color: #16a34a; /* green-600 */
        }
        .password-requirement.invalid {
            color: #dc2626; /* red-600 */
        }

        /* Vehicle Type Buttons Layout */
        .vehicle-type-buttons-container {
            display: flex;
            flex-wrap: wrap; /* Allows wrapping on smaller screens */
            justify-content: center; /* Center buttons horizontally */
            gap: 1rem; /* Space between buttons */
        }
        @media (min-width: 640px) { /* On small screens and up */
            .vehicle-type-buttons-container {
                justify-content: space-evenly; /* Evenly distribute space */
            }
        }
        @media (min-width: 768px) { /* On medium screens and up */
            .vehicle-type-buttons-container {
                justify-content: space-around; /* Spread out more */
            }
        }

        /* Script Display Area */
        #script-display {
            background-color: #e0f2fe; /* Light blue background */
            border: 1px solid #90cdf4; /* Blue border */
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            font-size: 1.125rem; /* text-lg */
            font-weight: 500;
            color: #1e40af; /* Dark blue text */
            text-align: center;
        }
    </style>
</head>
<body class="bg-gray-50">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-4xl">
        <header class="text-center mb-10">
            <img src="https://michieauto.com/logo.jpeg" alt="Michie Auto Detailing Logo" class="mx-auto mb-4 w-64 h-auto rounded-lg shadow-md">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">Michie Auto Detailing - Call Center Tool</h1>
        </header>

        <!-- Dynamic Script Display -->
        <div id="script-display">
            <!-- Script text will be injected here by JavaScript -->
        </div>

        <!-- Initial Script Section -->
        <div id="initial-script-section" class="bg-white p-8 rounded-xl shadow-lg text-center mb-8">
            <div class="flex flex-col sm:flex-row justify-center gap-4">
                <button id="btn-pricing" class="btn-primary">Calling about pricing</button>
                <button id="btn-scheduling" class="btn-primary">Calling about scheduling</button>
                <button id="btn-other-calls" class="btn-primary">All other calls</button>
            </div>
        </div>

        <!-- Pricing Section -->
        <div id="pricing-section" class="hidden bg-white p-8 rounded-xl shadow-lg space-y-8 mb-8">
            <!-- Pricing: Vehicle Type Selection -->
            <div id="pricing-vehicle-type-selection">
                <div class="vehicle-type-buttons-container">
                    <button id="pricing-select-car-type" class="btn-primary">Car</button>
                    <button id="pricing-select-truck-type" class="btn-primary">Truck</button>
                    <button id="pricing-select-suv-type" class="btn-primary">SUV</button>
                </div>
                <button id="back-to-main-from-pricing-vehicle" class="btn-secondary mt-8">Back to Main Script</button>
            </div>

            <!-- Pricing: Intro to Levels -->
            <div id="pricing-intro-levels" class="hidden text-center">
                <button id="btn-ok-intro-levels" class="btn-primary">OK</button>
                <button id="back-to-pricing-vehicle-type-from-intro" class="btn-secondary mt-8">Back to Vehicle Type</button>
            </div>

            <!-- Pricing: Pet Hair Question -->
            <div id="pricing-pet-hair-question" class="hidden text-center">
                <div class="flex flex-col sm:flex-row justify-center gap-4">
                    <button id="btn-pet-hair-yes" class="btn-primary">Yes</button>
                    <button id="btn-pet-hair-no" class="btn-primary">No</button>
                </div>
                <button id="back-to-intro-levels-from-pet-hair" class="btn-secondary mt-8">Back to Intro</button>
            </div>

            <!-- Pricing: Shampoo Question -->
            <div id="pricing-shampoo-question" class="hidden text-center">
                <div class="flex flex-col sm:flex-row justify-center gap-4">
                    <button id="btn-shampoo-yes" class="btn-primary">Yes</button>
                    <button id="btn-shampoo-no" class="btn-secondary">No</button>
                </div>
                <button id="back-to-pet-hair-from-shampoo" class="btn-secondary mt-8">Back to Pet Hair</button>
            </div>

            <!-- Pricing: Level 2 Recommendation -->
            <div id="pricing-level2-recommendation" class="hidden text-center">
                <div class="flex flex-col sm:flex-row justify-center gap-4">
                    <button id="btn-level2-yes" class="btn-success">Yes (Schedule Service)</button>
                    <button id="btn-level2-no" class="btn-secondary">No (Downsell)</button>
                </div>
                <button id="back-to-shampoo-from-level2" class="btn-secondary mt-8">Back to Shampoo</button>
            </div>

            <!-- Pricing: Level 1 Recommendation (Downsell or Direct) -->
            <div id="pricing-level1-recommendation" class="hidden text-center">
                <div class="flex flex-col sm:flex-row justify-center gap-4">
                    <button id="btn-level1-yes" class="btn-success">Yes (Schedule Service)</button>
                    <button id="btn-level1-no" class="btn-secondary">No (Other Calls)</button>
                </div>
                <button id="back-to-level2-from-level1" class="btn-secondary mt-8">Back to Level 2</button>
            </div>

            <!-- Pricing: Full Package Details (Hidden by default, shown when needed for reference) -->
            <div id="pricing-full-package-details" class="hidden">
                <h3 class="col-span-full text-xl font-semibold text-gray-700 mb-4 text-center">Full Package Details for Reference</h3>
                <div class="text-center mb-6">
                    <button id="toggle-pricing-sedan" class="btn-secondary mr-2">Show Sedan Pricing</button>
                    <button id="toggle-pricing-suv-truck" class="btn-secondary">Show SUV/Truck Pricing</button>
                </div>
                <div id="sedan-packages-display" class="pricing-grid hidden">
                    <!-- Sedan Package Cards -->
                    <div class="pricing-card">
                        <h4 class="pricing-level">Level 1 Detail</h4>
                        <p class="pricing-price">$149</p>
                        <button class="see-whats-included-btn" data-target="sedan-level1-features">See what's included</button>
                        <div id="sedan-level1-features" class="feature-dropdown">
                            <ul class="feature-list">
                                <li>External high pressure wash</li>
                                <li>Tire cleaner</li>
                                <li>Window cleaning inside and out</li>
                                <li>Deep vaccuming</li>
                                <li>Display controls and panels wipedown</li>
                                <li>Mirror cleaning</li>
                                <li>Seat vaccum</li>
                                <li>Surface protectent for the dash and display/controls</li>
                                <li>Steering wheel and dash clean</li>
                            </ul>
                        </div>
                    </div>
                    <div class="pricing-card">
                        <h4 class="pricing-level">Level 2 Detail</h4>
                        <p class="pricing-price">$249</p>
                        <button class="see-whats-included-btn" data-target="sedan-level2-features">See what's included</button>
                        <div id="sedan-level2-features" class="feature-dropdown">
                            <ul class="feature-list">
                                <li>External high pressure wash</li>
                                <li>Tire cleaner</li>
                                <li>Window cleaning inside and out</li>
                                <li>Deep vaccuming</li>
                                <li>Display controls and panels wipedown</li>
                                <li>Mirror cleaning</li>
                                <li>Seat vaccum</li>
                                <li>Surface protectent for the dash and display/controls</li>
                                <li>Steering wheel and dash clean</li>
                                <li>Shampoo carpets and seats</li>
                                <li>Premium Leather treatment</li>
                                <li>Door jam cleaning</li>
                                <li>Rims and tires cleaned and wiped down</li>
                                <li>Console scrub down</li>
                                <li>Pet hair removal</li>
                                <li>Odor removal</li>
                            </ul>
                        </div>
                    </div>
                    <div class="pricing-card">
                        <h4 class="pricing-level">Level 3 Detail</h4>
                        <p class="pricing-price">$349</p>
                        <button class="see-whats-included-btn" data-target="sedan-level3-features">See what's included</button>
                        <div id="sedan-level3-features" class="feature-dropdown">
                            <ul class="feature-list">
                                <li>External high pressure wash</li>
                                <li>Tire cleaner</li>
                                <li>Window cleaning inside and out</li>
                                <li>Deep vaccuming</li>
                                <li>Display controls and panels wipedown</li>
                                <li>Mirror cleaning</li>
                                <li>Seat vaccum</li>
                                <li>Surface protectent for the dash and display/controls</li>
                                <li>Steering wheel and dash clean</li>
                                <li>Shampoo carpets and seats</li>
                                <li>Premium Leather treatment</li>
                                <li>Door jam cleaning</li>
                                <li>Rims and tires cleaned and wiped down</li>
                                <li>Console scrub down</li>
                                <li>Pet hair removal</li>
                                <li>Odor removal</li>
                                <li>FINE TOOTH COMB in between seats cleaning</li>
                                <li>Glove compartment cleaning</li>
                                <li>Trunk shampoo and vaccum</li>
                                <li>Door controls cleaning</li>
                                <li>Hard to reach areas deep level shampoo</li>
                                <li>Meticulous cleaning of all frequently touched surfaces</li>
                                <li>External bug removal</li>
                                <li>Free microfiber cloth</li>
                                <li>Protection plan (complimentary maintenance clean within 15 days)</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div id="suv-truck-packages-display" class="pricing-grid hidden">
                    <h3 class="col-span-full text-xl font-semibold text-gray-700 mb-4 text-center">SUV/Truck Packages</h3>
                    <!-- SUV/Truck Package Cards -->
                    <div class="pricing-card">
                        <h4 class="pricing-level">Level 1 Detail</h4>
                        <p class="pricing-price">$199</p>
                        <button class="see-whats-included-btn" data-target="suv-truck-level1-features">See what's included</button>
                        <div id="suv-truck-level1-features" class="feature-dropdown">
                            <ul class="feature-list">
                                <li>External high pressure wash</li>
                                <li>Tire cleaner</li>
                                <li>Window cleaning inside and out</li>
                                <li>Deep vaccuming</li>
                                <li>Display controls and panels wipedown</li>
                                <li>Mirror cleaning</li>
                                <li>Seat vaccum</li>
                                <li>Surface protectent for the dash and display/controls</li>
                                <li>Steering wheel and dash clean</li>
                            </ul>
                        </div>
                    </div>
                    <div class="pricing-card">
                        <h4 class="pricing-level">Level 2 Detail</h4>
                        <p class="pricing-price">$299</p>
                        <button class="see-whats-included-btn" data-target="suv-truck-level2-features">See what's included</button>
                        <div id="suv-truck-level2-features" class="feature-dropdown">
                            <ul class="feature-list">
                                <li>External high pressure wash</li>
                                <li>Tire cleaner</li>
                                <li>Window cleaning inside and out</li>
                                <li>Deep vaccuming</li>
                                <li>Display controls and panels wipedown</li>
                                <li>Mirror cleaning</li>
                                <li>Seat vaccum</li>
                                <li>Surface protectent for the dash and display/controls</li>
                                <li>Steering wheel and dash clean</li>
                                <li>Shampoo carpets and seats</li>
                                <li>Premium Leather treatment</li>
                                <li>Door jam cleaning</li>
                                <li>Rims and tires cleaned and wiped down</li>
                                <li>Console scrub down</li>
                                <li>Pet hair removal</li>
                                <li>Odor removal</li>
                            </ul>
                        </div>
                    </div>
                    <div class="pricing-card">
                        <h4 class="pricing-level">Level 3 Detail</h4>
                        <p class="pricing-price">$399</p>
                        <button class="see-whats-included-btn" data-target="suv-truck-level3-features">See what's included</button>
                        <div id="suv-truck-level3-features" class="feature-dropdown">
                            <ul class="feature-list">
                                <li>External high pressure wash</li>
                                <li>Tire cleaner</li>
                                <li>Window cleaning inside and out</li>
                                <li>Deep vaccuming</li>
                                <li>Display controls and panels wipedown</li>
                                <li>Mirror cleaning</li>
                                <li>Seat vaccum</li>
                                <li>Surface protectent for the dash and display/controls</li>
                                <li>Steering wheel and dash clean</li>
                                <li>Shampoo carpets and seats</li>
                                <li>Premium Leather treatment</li>
                                <li>Door jam cleaning</li>
                                <li>Rims and tires cleaned and wiped down</li>
                                <li>Console scrub down</li>
                                <li>Pet hair removal</li>
                                <li>Odor removal</li>
                                <li>FINE TOOTH COMB in between seats cleaning</li>
                                <li>Glove compartment cleaning</li>
                                <li>Trunk shampoo and vaccum</li>
                                <li>Door controls cleaning</li>
                                <li>Hard to reach areas deep level shampoo</li>
                                <li>Meticulous cleaning of all frequently touched surfaces</li>
                                <li>External bug removal</li>
                                <li>Free microfiber cloth</li>
                                <li>Protection plan (complimentary maintenance clean within 15 days)</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scheduling Section (Booking Flow) -->
        <div id="scheduling-section" class="hidden bg-white p-8 rounded-xl shadow-lg space-y-8">
            <!-- Scheduling: Vehicle Type Selection -->
            <div id="scheduling-vehicle-type-selection">
                <h2 class="text-2xl font-bold text-gray-700 mb-6 text-center">1. Select Your Vehicle Type</h2>
                <div class="vehicle-type-buttons-container">
                    <button id="scheduling-select-car-type" class="btn-primary">Car</button>
                    <button id="scheduling-select-truck-type" class="btn-primary">Truck</button>
                    <button id="scheduling-select-suv-type" class="btn-primary">SUV</button>
                </div>
                <button id="back-to-main-from-scheduling-vehicle" class="btn-secondary mt-8">Back to Main Script</button>
            </div>

            <!-- Scheduling: Package Selection -->
            <div id="scheduling-package-selection-container" class="hidden">
                <h2 class="text-2xl font-bold text-gray-700 mb-8 text-center">2. Choose Your Detail Package</h2>
                <div id="sedan-packages-booking-display" class="pricing-grid hidden">
                    <!-- Sedan Package Cards for Booking -->
                    <div class="pricing-card">
                        <h4 class="pricing-level">Level 1 Detail</h4>
                        <p class="pricing-price">$149</p>
                        <button class="see-whats-included-btn" data-target="booking-sedan-level1-features">See what's included</button>
                        <div id="booking-sedan-level1-features" class="feature-dropdown">
                            <ul class="feature-list">
                                <li>External high pressure wash</li>
                                <li>Tire cleaner</li>
                                <li>Window cleaning inside and out</li>
                                <li>Deep vaccuming</li>
                                <li>Display controls and panels wipedown</li>
                                <li>Mirror cleaning</li>
                                <li>Seat vaccum</li>
                                <li>Surface protectent for the dash and display/controls</li>
                                <li>Steering wheel and dash clean</li>
                            </ul>
                        </div>
                        <button class="select-package-btn btn-success" data-package-type="Level 1 Detail" data-package-price="149" data-vehicle-type="car">Select Package</button>
                    </div>
                    <div class="pricing-card">
                        <h4 class="pricing-level">Level 2 Detail</h4>
                        <p class="pricing-price">$249</p>
                        <button class="see-whats-included-btn" data-target="booking-sedan-level2-features">See what's included</button>
                        <div id="booking-sedan-level2-features" class="feature-dropdown">
                            <ul class="feature-list">
                                <li>External high pressure wash</li>
                                <li>Tire cleaner</li>
                                <li>Window cleaning inside and out</li>
                                <li>Deep vaccuming</li>
                                <li>Display controls and panels wipedown</li>
                                <li>Mirror cleaning</li>
                                <li>Seat vaccum</li>
                                <li>Surface protectent for the dash and display/controls</li>
                                <li>Steering wheel and dash clean</li>
                                <li>Shampoo carpets and seats</li>
                                <li>Premium Leather treatment</li>
                                <li>Door jam cleaning</li>
                                <li>Rims and tires cleaned and wiped down</li>
                                <li>Console scrub down</li>
                                <li>Pet hair removal</li>
                                <li>Odor removal</li>
                            </ul>
                        </div>
                        <button class="select-package-btn btn-success" data-package-type="Level 2 Detail" data-package-price="249" data-vehicle-type="car">Select Package</button>
                    </div>
                    <div class="pricing-card">
                        <h4 class="pricing-level">Level 3 Detail</h4>
                        <p class="pricing-price">$349</p>
                        <button class="see-whats-included-btn" data-target="booking-sedan-level3-features">See what's included</button>
                        <div id="booking-sedan-level3-features" class="feature-dropdown">
                            <ul class="feature-list">
                                <li>External high pressure wash</li>
                                <li>Tire cleaner</li>
                                <li>Window cleaning inside and out</li>
                                <li>Deep vaccuming</li>
                                <li>Display controls and panels wipedown</li>
                                <li>Mirror cleaning</li>
                                <li>Seat vaccum</li>
                                <li>Surface protectent for the dash and display/controls</li>
                                <li>Steering wheel and dash clean</li>
                                <li>Shampoo carpets and seats</li>
                                <li>Premium Leather treatment</li>
                                <li>Door jam cleaning</li>
                                <li>Rims and tires cleaned and wiped down</li>
                                <li>Console scrub down</li>
                                <li>Pet hair removal</li>
                                <li>Odor removal</li>
                                <li>FINE TOOTH COMB in between seats cleaning</li>
                                <li>Glove compartment cleaning</li>
                                <li>Trunk shampoo and vaccum</li>
                                <li>Door controls cleaning</li>
                                <li>Hard to reach areas deep level shampoo</li>
                                <li>Meticulous cleaning of all frequently touched surfaces</li>
                                <li>External bug removal</li>
                                <li>Free microfiber cloth</li>
                                <li>Protection plan (complimentary maintenance clean within 15 days)</li>
                            </ul>
                        </div>
                        <button class="select-package-btn btn-success" data-package-type="Level 3 Detail" data-package-price="349" data-vehicle-type="car">Select Package</button>
                    </div>
                </div>
                <div id="suv-truck-packages-booking-display" class="pricing-grid hidden">
                    <!-- SUV/Truck Package Cards for Booking -->
                    <div class="pricing-card">
                        <h4 class="pricing-level">Level 1 Detail</h4>
                        <p class="pricing-price">$199</p>
                        <button class="see-whats-included-btn" data-target="booking-suv-truck-level1-features">See what's included</button>
                        <div id="suv-truck-level1-features" class="feature-dropdown">
                            <ul class="feature-list">
                                <li>External high pressure wash</li>
                                <li>Tire cleaner</li>
                                <li>Window cleaning inside and out</li>
                                <li>Deep vaccuming</li>
                                <li>Display controls and panels wipedown</li>
                                <li>Mirror cleaning</li>
                                <li>Seat vaccum</li>
                                <li>Surface protectent for the dash and display/controls</li>
                                <li>Steering wheel and dash clean</li>
                            </ul>
                        </div>
                        <button class="select-package-btn btn-success" data-package-type="Level 1 Detail" data-package-price="199" data-vehicle-type="suv-truck">Select Package</button>
                    </div>
                    <div class="pricing-card">
                        <h4 class="pricing-level">Level 2 Detail</h4>
                        <p class="pricing-price">$299</p>
                        <button class="see-whats-included-btn" data-target="booking-suv-truck-level2-features">See what's included</button>
                        <div id="booking-suv-truck-level2-features" class="feature-dropdown">
                            <ul class="feature-list">
                                <li>External high pressure wash</li>
                                <li>Tire cleaner</li>
                                <li>Window cleaning inside and out</li>
                                <li>Deep vaccuming</li>
                                <li>Display controls and panels wipedown</li>
                                <li>Mirror cleaning</li>
                                <li>Seat vaccum</li>
                                <li>Surface protectent for the dash and display/controls</li>
                                <li>Steering wheel and dash clean</li>
                                <li>Shampoo carpets and seats</li>
                                <li>Premium Leather treatment</li>
                                <li>Door jam cleaning</li>
                                <li>Rims and tires cleaned and wiped down</li>
                                <li>Console scrub down</li>
                                <li>Pet hair removal</li>
                                <li>Odor removal</li>
                            </ul>
                        </div>
                        <button class="select-package-btn btn-success" data-package-type="Level 2 Detail" data-package-price="299" data-vehicle-type="suv-truck">Select Package</button>
                    </div>
                    <div class="pricing-card">
                        <h4 class="pricing-level">Level 3 Detail</h4>
                        <p class="pricing-price">$399</p>
                        <button class="see-whats-included-btn" data-target="booking-suv-truck-level3-features">See what's included</button>
                        <div id="suv-truck-level3-features" class="feature-dropdown">
                            <ul class="feature-list">
                                <li>External high pressure wash</li>
                                <li>Tire cleaner</li>
                                <li>Window cleaning inside and out</li>
                                <li>Deep vaccuming</li>
                                <li>Display controls and panels wipedown</li>
                                <li>Mirror cleaning</li>
                                <li>Seat vaccum</li>
                                <li>Surface protectent for the dash and display/controls</li>
                                <li>Steering wheel and dash clean</li>
                                <li>Shampoo carpets and seats</li>
                                <li>Premium Leather treatment</li>
                                <li>Door jam cleaning</li>
                                <li>Rims and tires cleaned and wiped down</li>
                                <li>Console scrub down</li>
                                <li>Pet hair removal</li>
                                <li>Odor removal</li>
                                <li>FINE TOOTH COMB in between seats cleaning</li>
                                <li>Glove compartment cleaning</li>
                                <li>Trunk shampoo and vaccum</li>
                                <li>Door controls cleaning</li>
                                <li>Hard to reach areas deep level shampoo</li>
                                <li>Meticulous cleaning of all frequently touched surfaces</li>
                                <li>External bug removal</li>
                                <li>Free microfiber cloth</li>
                                <li>Protection plan (complimentary maintenance clean within 15 days)</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <button id="back-to-scheduling-vehicle-type" class="btn-secondary mt-8">Back to Vehicle Type</button>
            </div>

            <!-- Main Booking Form - Broken into steps -->
            <div id="booking-form-section" class="hidden">
                <p class="text-lg font-semibold text-gray-800 mb-4">Selected Package: <span id="selected-package-display" class="text-blue-600"></span></p>
                
                <!-- Booking Step 1: Full Name -->
                <div id="booking-step-name" class="space-y-6">
                    <div>
                        <label for="full-name" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                        <input type="text" id="full-name" placeholder="Your Full Name" required>
                    </div>
                    <button id="btn-next-name" class="btn-primary">Next</button>
                    <button id="back-to-package-selection" class="btn-secondary mt-8">Back to Package Selection</button>
                </div>

                <!-- Booking Step 2: Email & Phone -->
                <div id="booking-step-contact" class="hidden space-y-6">
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                        <input type="email" id="email" placeholder="Your Email Address" required>
                    </div>
                    <div>
                        <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                        <input type="tel" id="phone" placeholder="Your Phone Number" required>
                    </div>
                    <button id="btn-next-contact" class="btn-primary">Next</button>
                    <button id="back-to-name-step" class="btn-secondary mt-8">Back</button>
                </div>

                <!-- Booking Step 3: Address & Zip -->
                <div id="booking-step-address" class="hidden space-y-6">
                    <div>
                        <label for="address-input" class="block text-sm font-medium text-gray-700 mb-1">Service Address</label>
                        <input type="text" id="address-input" placeholder="Start typing your address..." required>
                    </div>
                    <div>
                        <label for="zip-code" class="block text-sm font-medium text-gray-700 mb-1">Zip Code</label>
                        <input type="text" id="zip-code" placeholder="Your Zip Code" required>
                    </div>
                    <button id="btn-next-address" class="btn-primary">Next</button>
                    <button id="back-to-contact-step" class="btn-secondary mt-8">Back</button>
                </div>

                <!-- Booking Step 4: Vehicle Details -->
                <div id="booking-step-vehicle" class="hidden space-y-6">
                    <div>
                        <label for="vehicle-year" class="block text-sm font-medium text-gray-700 mb-1">Vehicle Year</label>
                        <input type="text" id="vehicle-year" placeholder="e.g., 2020" required>
                    </div>
                    <div>
                        <label for="vehicle-make" class="block text-sm font-medium text-gray-700 mb-1">Vehicle Make</label>
                        <select id="vehicle-make" required class="w-full px-3 py-2 border rounded-lg">
                            <option value="">Select Make</option>
                            <option value="Acura">Acura</option>
                            <option value="Audi">Audi</option>
                            <option value="BMW">BMW</option>
                            <option value="Buick">Buick</option>
                            <option value="Cadillac">Cadillac</option>
                            <option value="Chevrolet">Chevrolet</option>
                            <option value="Chrysler">Chrysler</option>
                            <option value="Dodge">Dodge</option>
                            <option value="Ford">Ford</option>
                            <option value="GMC">GMC</option>
                            <option value="Honda">Honda</option>
                            <option value="Hyundai">Hyundai</option>
                            <option value="Infiniti">Infiniti</option>
                            <option value="Jaguar">Jaguar</option>
                            <option value="Jeep">Jeep</option>
                            <option value="Kia">Kia</option>
                            <option value="Land Rover">Land Rover</option>
                            <option value="Lexus">Lexus</option>
                            <option value="Lincoln">Lincoln</option>
                            <option value="Mazda">Mazda</option>
                            <option value="Mercedes-Benz">Mercedes-Benz</option>
                            <option value="Mini">Mini</option>
                            <option value="Mitsubishi">Mitsubishi</option>
                            <option value="Nissan">Nissan</option>
                            <option value="Ram">Ram</option>
                            <option value="Subaru">Subaru</option>
                            <option value="Tesla">Tesla</option>
                            <option value="Toyota">Toyota</option>
                            <option value="Volkswagen">Volkswagen</option>
                            <option value="Volvo">Volvo</option>
                            <option value="Smart">Smart</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label for="vehicle-model" class="block text-sm font-medium text-gray-700 mb-1">Vehicle Model</label>
                        <input type="text" id="vehicle-model" placeholder="e.g., Civic" required>
                    </div>
                    
                    <!-- Create Account Option -->
                    <div class="mt-4">
                        <label class="flex items-center space-x-2 cursor-pointer text-gray-700">
                            <input type="checkbox" id="create-account-checkbox" class="rounded h-4 w-4 text-blue-600 focus:ring-blue-500">
                            <span>Create an account (Optional)</span>
                        </label>
                    </div>

                    <!-- Password Fields (Initially Hidden) -->
                    <div id="password-fields" class="space-y-4 hidden">
                        <div>
                            <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                            <input type="password" id="password" placeholder="Enter a password" autocomplete="new-password">
                            <div class="text-sm mt-1 pl-1 space-y-0.5">
                                <p id="password-length-req" class="password-requirement invalid">At least 6 characters</p>
                                <p id="password-uppercase-req" class="password-requirement invalid">At least 1 capital letter</p>
                            </div>
                        </div>
                        <div>
                            <label for="confirm-password" class="block text-sm font-medium text-gray-700 mb-1">Confirm Password</label>
                            <input type="password" id="confirm-password" placeholder="Confirm your password">
                            <p id="password-match-message" class="text-sm text-red-600 mt-1 pl-1 hidden">Passwords do not match.</p>
                        </div>
                    </div>

                    <button id="btn-next-vehicle" class="btn-primary">Next</button>
                    <button id="back-to-address-step" class="btn-secondary mt-8">Back</button>
                </div>

                <!-- Booking Step 5: Date & Time -->
                <div id="booking-step-datetime" class="hidden space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="booking-date" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                            <input type="date" id="booking-date" required>
                        </div>
                        <div>
                            <label for="selected-booking-time" class="block text-sm font-medium text-gray-700 mb-1">Time</label>
                            <div id="booking-time-buttons" class="grid grid-cols-3 gap-2"></div>
                            <input type="hidden" id="selected-booking-time" name="booking-time" required>
                        </div>
                    </div>
                    <button type="submit" id="final-book-appointment-btn" class="w-full btn-success">Book Appointment</button>
                    <p id="booking-message" class="text-center mt-2"></p>
                    <button id="back-to-vehicle-step" class="btn-secondary mt-8">Back</button>
                </div>

                <!-- Hidden inputs for package details -->
                <input type="hidden" id="selected-package-type" name="package-type">
                <input type="hidden" id="selected-package-price" name="package-price">
                <input type="hidden" id="selected-vehicle-type" name="vehicle-type">
            </div>

            <!-- Confirmation Message - Updated to include payment options -->
            <div id="confirmation-section" class="hidden text-center">
                <div id="confirmation-message" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-6 rounded-lg">
                    <!-- Script will be inserted here -->
                </div>
                
                <div class="mt-8 space-y-4" id="payment-options-buttons">
                    <!-- Deposit Option -->
                    <div>
                        <button id="pay-deposit-button" class="btn-success">Pay $50 deposit</button>
                        <p class="text-xs text-gray-500 mt-2">(Pay the remaining due after service completion)</p>
                    </div>

                    <!-- OR Separator -->
                    <p class="text-xl font-bold text-gray-600">OR</p>

                    <!-- Pay in Full Option -->
                    <div>
                        <button id="pay-now-button" class="btn-primary">Pay in full</button>
                    </div>
                </div>
                <button id="back-to-main-from-confirmation" class="btn-secondary mt-8">Back to Main Script</button>
            </div>

            <!-- NEW: Did you make payment? screen -->
            <div id="payment-confirmation-question-section" class="hidden text-center bg-white p-8 rounded-xl shadow-lg space-y-6">
                <div id="payment-confirmation-question-message" class="bg-blue-100 border-l-4 border-blue-500 text-blue-800 p-6 rounded-lg">
                    <!-- Message will be inserted here -->
                </div>
                <div class="flex flex-col sm:flex-row justify-center gap-4">
                    <button id="btn-payment-confirmed-yes" class="btn-primary">Yes</button>
                    <button id="btn-payment-confirmed-no" class="btn-secondary">No</button>
                </div>
            </div>

            <!-- NEW: Waiting for payment manual screen -->
            <div id="waiting-for-payment-manual-section" class="hidden text-center bg-white p-8 rounded-xl shadow-lg space-y-6">
                <div id="waiting-for-payment-manual-message" class="bg-green-100 border-l-4 border-green-500 text-green-800 p-6 rounded-lg">
                    <!-- Message will be inserted here -->
                </div>
                <button id="btn-payment-done-manual" class="btn-success">Payment is Complete</button>
            </div>

            <!-- NEW: Final confirmation manual screen -->
            <div id="final-confirmation-manual-section" class="hidden text-center bg-white p-8 rounded-xl shadow-lg space-y-6">
                <div id="final-confirmation-manual-message" class="bg-green-100 border-l-4 border-green-500 text-green-800 p-6 rounded-lg">
                    <!-- Message will be inserted here -->
                </div>
                <button id="btn-send-confirmation-text" class="btn-primary">Send Confirmation Text</button>
                <button id="btn-end-call" class="btn-secondary">End Call</button>
            </div>


            <!-- Policy Text -->
            <div id="policy-text" class="hidden text-xs text-gray-500 mt-8 space-y-2">
                <p>* <strong>Deposit Policy:</strong> Paying in full is optional before the detail is completed, however, if you choose to not pay in full, a $50 deposit is required to secure your appointment, and this goes towards the cost of your detail service. The remaining balance will be collected after service is completed. In the event that you cancel the appointment, the $50 deposit paid is non-refundable. Reschedules are always free.</p>
                <p>* <strong>Paid in Full Policy:</strong> If you paid in full and cancel your appointment, no cancel fee will be charged, instead, 100% of the amount paid will be provided to you as an auto detailing credit, valid for any detail with Michie Auto Detailing LLC in the next 12 months. This is similar to a gift card, no cash refunds are provided.</p>
            </div>
        </div>

        <!-- Other Calls Section -->
        <div id="other-calls-section" class="hidden bg-white p-8 rounded-xl shadow-lg mb-8">
            <textarea id="other-calls-notes" rows="10" placeholder="Enter notes for this call here..." class="w-full"></textarea>
            <button id="back-to-main-from-other" class="btn-secondary mt-4">Back to Main Script</button>
        </div>

    </div>

    <!-- IMPORTANT: Replace AIzaSyB133ISKHPtat18iloHDlqm2QHBv133sOk with your actual Google Cloud API Key -->
    <!-- This script tag MUST be the last element before the closing </body> tag. -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB133ISKHPtat18iloHDlqm2QHBv133sOk&libraries=places&callback=initBookingPage" async defer></script>
    <script>
        // This function needs to be available for the autocomplete callback
        function fillAddressFields(place, zipCodeInputId) {
            let zipCode = '';
            for (const component of place.address_components) {
                if (component.types.includes('postal_code')) {
                    zipCode = component.long_name;
                }
            }
            const zipCodeInput = document.getElementById(zipCodeInputId);
            if(zipCodeInput) {
                zipCodeInput.value = zipCode;
            }
        }

        // The main application logic, including form event listeners.
        // This function will now be called by the Google Maps script as its callback.
        window.initBookingPage = function() {
            try {
                // Set API_BASE_URL to match the working book.html's configuration
                const API_BASE_URL = 'https://michie-detailing-admin.onrender.com'; 
                
                const elements = {
                    scriptDisplay: document.getElementById('script-display'),
                    initialScriptSection: document.getElementById('initial-script-section'),
                    btnPricing: document.getElementById('btn-pricing'),
                    btnScheduling: document.getElementById('btn-scheduling'),
                    btnOtherCalls: document.getElementById('btn-other-calls'),
                    pricingSection: document.getElementById('pricing-section'),
                    schedulingSection: document.getElementById('scheduling-section'),
                    otherCallsSection: document.getElementById('other-calls-section'),

                    // Back buttons
                    backToMainFromPricingVehicle: document.getElementById('back-to-main-from-pricing-vehicle'),
                    backToPricingVehicleTypeFromIntro: document.getElementById('back-to-pricing-vehicle-type-from-intro'),
                    backToIntroLevelsFromPetHair: document.getElementById('back-to-intro-levels-from-pet-hair'),
                    backToPetHairFromShampoo: document.getElementById('back-to-pet-hair-from-shampoo'),
                    backToShampooFromLevel2: document.getElementById('back-to-shampoo-from-level2'),
                    backToLevel2FromLevel1: document.getElementById('back-to-level2-from-level1'),
                    
                    backToMainFromSchedulingVehicle: document.getElementById('back-to-main-from-scheduling-vehicle'),
                    backToSchedulingVehicleType: document.getElementById('back-to-scheduling-vehicle-type'),
                    backToPackageSelection: document.getElementById('back-to-package-selection'), // From booking-step-name
                    backToNameStep: document.getElementById('back-to-name-step'), // From booking-step-contact
                    backToContactStep: document.getElementById('back-to-contact-step'), // From booking-step-address
                    backToAddressStep: document.getElementById('back-to-address-step'), // From booking-step-vehicle
                    backToVehicleStep: document.getElementById('back-to-vehicle-step'), // From booking-step-datetime

                    backToMainFromConfirmation: document.getElementById('back-to-main-from-confirmation'),
                    backToMainFromOther: document.getElementById('back-to-main-from-other'),

                    // Pricing specific elements
                    pricingVehicleTypeSelection: document.getElementById('pricing-vehicle-type-selection'),
                    pricingSelectCarBtn: document.getElementById('pricing-select-car-type'), 
                    pricingSelectTruckBtn: document.getElementById('pricing-select-truck-type'), 
                    pricingSelectSuvBtn: document.getElementById('pricing-select-suv-type'), 
                    pricingIntroLevels: document.getElementById('pricing-intro-levels'),
                    btnOkIntroLevels: document.getElementById('btn-ok-intro-levels'),
                    pricingPetHairQuestion: document.getElementById('pricing-pet-hair-question'),
                    btnPetHairYes: document.getElementById('btn-pet-hair-yes'),
                    btnPetHairNo: document.getElementById('btn-pet-hair-no'),
                    pricingShampooQuestion: document.getElementById('pricing-shampoo-question'),
                    btnShampooYes: document.getElementById('btn-shampoo-yes'),
                    btnShampooNo: document.getElementById('btn-shampoo-no'),
                    pricingLevel2Recommendation: document.getElementById('pricing-level2-recommendation'),
                    btnLevel2Yes: document.getElementById('btn-level2-yes'),
                    btnLevel2No: document.getElementById('btn-level2-no'),
                    pricingLevel1Recommendation: document.getElementById('btn-level1-recommendation'),
                    btnLevel1Yes: document.getElementById('btn-level1-yes'),
                    btnLevel1No: document.getElementById('btn-level1-no'),
                    pricingFullPackageDetails: document.getElementById('pricing-full-package-details'), // For reference
                    togglePricingSedan: document.getElementById('toggle-pricing-sedan'),
                    togglePricingSuvTruck: document.getElementById('toggle-pricing-suv-truck'),
                    sedanPackagesDisplay: document.getElementById('sedan-packages-display'), 
                    suvTruckPackagesDisplay: document.getElementById('suv-truck-packages-display'), 

                    // Scheduling specific elements (from original booking flow)
                    schedulingVehicleTypeSelection: document.getElementById('scheduling-vehicle-type-selection'),
                    schedulingSelectCarBtn: document.getElementById('scheduling-select-car-type'), 
                    schedulingSelectTruckBtn: document.getElementById('scheduling-select-truck-type'), 
                    schedulingSelectSuvBtn: document.getElementById('scheduling-select-suv-type'), 
                    schedulingPackageSelectionContainer: document.getElementById('scheduling-package-selection-container'),
                    sedanPackagesBookingDisplay: document.getElementById('sedan-packages-booking-display'), 
                    suvTruckPackagesBookingDisplay: document.getElementById('suv-truck-packages-booking-display'), 
                    bookingFormSection: document.getElementById('booking-form-section'),
                    bookingStepName: document.getElementById('booking-step-name'),
                    btnNextName: document.getElementById('btn-next-name'),
                    bookingStepContact: document.getElementById('booking-step-contact'),
                    btnNextContact: document.getElementById('btn-next-contact'),
                    bookingStepAddress: document.getElementById('booking-step-address'),
                    btnNextAddress: document.getElementById('btn-next-address'),
                    bookingStepVehicle: document.getElementById('booking-step-vehicle'),
                    btnNextVehicle: document.getElementById('btn-next-vehicle'),
                    bookingStepDatetime: document.getElementById('booking-step-datetime'),
                    
                    bookingForm: document.getElementById('booking-form'), 
                    selectedPackageDisplay: document.getElementById('selected-package-display'),
                    selectedPackageTypeInput: document.getElementById('selected-package-type'),
                    selectedPackagePriceInput: document.getElementById('selected-package-price'),
                    selectedVehicleTypeInput: document.getElementById('selected-vehicle-type'), 
                    finalBookAppointmentBtn: document.getElementById('final-book-appointment-btn'),
                    confirmationSection: document.getElementById('confirmation-section'),
                    confirmationMessageDiv: document.getElementById('confirmation-message'), 
                    paymentOptionsButtons: document.getElementById('payment-options-buttons'), 
                    payNowButton: document.getElementById('pay-now-button'), 
                    payDepositButton: document.getElementById('pay-deposit-button'), 

                    // NEW Manual SMS Flow Elements
                    paymentConfirmationQuestionSection: document.getElementById('payment-confirmation-question-section'),
                    paymentConfirmationQuestionMessage: document.getElementById('payment-confirmation-question-message'),
                    btnPaymentConfirmedYes: document.getElementById('btn-payment-confirmed-yes'),
                    btnPaymentConfirmedNo: document.getElementById('btn-payment-confirmed-no'),
                    waitingForPaymentManualSection: document.getElementById('waiting-for-payment-manual-section'),
                    waitingForPaymentManualMessage: document.getElementById('waiting-for-payment-manual-message'),
                    btnPaymentDoneManual: document.getElementById('btn-payment-done-manual'),
                    finalConfirmationManualSection: document.getElementById('final-confirmation-manual-section'),
                    finalConfirmationManualMessage: document.getElementById('final-confirmation-manual-message'),
                    btnSendConfirmationText: document.getElementById('btn-send-confirmation-text'),
                    btnEndCall: document.getElementById('btn-end-call'),


                    policyText: document.getElementById('policy-text'),
                    bookingDateInput: document.getElementById('booking-date'),
                    bookingTimeButtonsContainer: document.getElementById('booking-time-buttons'),
                    selectedBookingTimeInput: document.getElementById('selected-booking-time'),
                    bookingMessage: document.getElementById('booking-message'),
                    otherCallsNotes: document.getElementById('other-calls-notes'),
                    
                    // Password fields
                    createAccountCheckbox: document.getElementById('create-account-checkbox'),
                    passwordFields: document.getElementById('password-fields'),
                    passwordInput: document.getElementById('password'),
                    confirmPasswordInput: document.getElementById('confirm-password'),
                    passwordLengthReq: document.getElementById('password-length-req'),
                    passwordUppercaseReq: document.getElementById('password-uppercase-req'),
                    passwordMatchMessage: document.getElementById('password-match-message')
                };

                // State variables for the script flow
                let currentVehicleType = '';
                let recommendedPackageType = '';
                let recommendedPackagePrice = 0;
                let finalBookingPayload = {}; // Store all booking data here until final submission

                // Package features for script generation
                const packageFeatures = {
                    "Level 1 Detail": {
                        "car": [
                            "External high pressure wash", "Tire cleaner", "Window cleaning inside and out",
                            "Deep vaccuming", "Display controls and panels wipedown", "Mirror cleaning",
                            "Seat vaccum", "Surface protectent for the dash and display/controls", "Steering wheel and dash clean"
                        ],
                        "suv-truck": [
                            "External high pressure wash", "Tire cleaner", "Window cleaning inside and out",
                            "Deep vaccuming", "Display controls and panels wipedown", "Mirror cleaning",
                            "Seat vaccum", "Surface protectent for the dash and display/controls", "Steering wheel and dash clean"
                        ]
                    },
                    "Level 2 Detail": {
                        "car": [
                            "External high pressure wash", "Tire cleaner", "Window cleaning inside and out",
                            "Deep vaccuming", "Display controls and panels wipedown", "Mirror cleaning",
                            "Seat vaccum", "Surface protectent for the dash and display/controls", "Steering wheel and dash clean",
                            "Shampoo carpets and seats", "Premium Leather treatment", "Door jam cleaning",
                            "Rims and tires cleaned and wiped down", "Console scrub down", "Pet hair removal", "Odor removal"
                        ],
                        "suv-truck": [
                            "External high pressure wash", "Tire cleaner", "Window cleaning inside and out",
                            "Deep vaccuming", "Display controls and panels wipedown", "Mirror cleaning",
                            "Seat vaccum", "Surface protectent for the dash and display/controls", "Steering wheel and dash clean",
                            "Shampoo carpets and seats", "Premium Leather treatment", "Door jam cleaning",
                            "Rims and tires cleaned and wiped down", "Console scrub down", "Pet hair removal", "Odor removal"
                        ]
                    },
                    "Level 3 Detail": {
                        "car": [
                            "External high pressure wash", "Tire cleaner", "Window cleaning inside and out",
                            "Deep vaccuming", "Display controls and panels wipedown", "Mirror cleaning",
                            "Seat vaccum", "Surface protectent for the dash and display/controls", "Steering wheel and dash clean",
                            "Shampoo carpets and seats", "Premium Leather treatment", "Door jam cleaning",
                            "Rims and tires cleaned and wiped down", "Console scrub down", "Pet hair removal", "Odor removal",
                            "FINE TOOTH COMB in between seats cleaning", "Glove compartment cleaning", "Trunk shampoo and vaccum",
                            "Door controls cleaning", "Hard to reach areas deep level shampoo",
                            "Meticulous cleaning of all frequently touched surfaces", "External bug removal",
                            "Free microfiber cloth", "Protection plan (complimentary maintenance clean within 15 days)"
                        ],
                        "suv-truck": [
                            "External high pressure wash", "Tire cleaner", "Window cleaning inside and out",
                            "Deep vaccuming", "Display controls and panels wipedown", "Mirror cleaning",
                            "Seat vaccum", "Surface protectent for the dash and display/controls", "Steering wheel and dash clean",
                            "Shampoo carpets and seats", "Premium Leather treatment", "Door jam cleaning",
                            "Rims and tires cleaned and wiped down", "Console scrub down", "Pet hair removal", "Odor removal",
                            "FINE TOOTH COMB in between seats cleaning", "Glove compartment cleaning", "Trunk shampoo and vaccum",
                            "Door controls cleaning", "Hard to reach areas deep level shampoo",
                            "Meticulous cleaning of all frequently touched surfaces", "External bug removal",
                            "Free microfiber cloth", "Protection plan (complimentary maintenance clean within 15 days)"
                        ]
                    }
                };


                const packagePrices = {
                    "Level 1 Detail": { "car": 149, "suv-truck": 199 },
                    "Level 2 Detail": { "car": 249, "suv-truck": 299 },
                    "Level 3 Detail": { "car": 349, "suv-truck": 399 }
                };

                // Script content definitions (updated to first person)
                const scriptContent = {
                    initial: "Thank you for calling Michie Auto Detail, are you calling to schedule an appointment?",
                    pricingVehicleType: "Absolutely! I'd love to get you some information on pricing. Are you calling about a car, truck, or SUV?",
                    pricingIntroLevels: "We have 3 levels of service to choose from. I'll just ask you a couple of questions to see which option is right for you, sound good?",
                    pricingPetHairQuestion: "Do you have any pet hair in your vehicle?",
                    pricingShampooQuestion: "Would you like your seats and carpets shampooed and renewed?",
                    pricingLevel2Recommendation: (vehicleType) => {
                        const features = packageFeatures["Level 2 Detail"][vehicleType].join(', ');
                        const price = packagePrices[recommendedPackageType][vehicleType];
                        return `Based on the information you've provided me, I'm going to recommend our most popular option, it's called level 2 detail service. It includes ${features}. The price is $${price}, does that sound good?`;
                    },
                    pricingLevel1Recommendation: (vehicleType) => {
                        const features = packageFeatures["Level 1 Detail"][vehicleType].join(', ');
                        const price = packagePrices[recommendedPackageType][vehicleType];
                        return `Based on the information you've provided me, I'm going to recommend our most affordable option, it's called level 1 detail service. It. It includes ${features}. The price is $${price}, does that sound good?`;
                    },
                    pricingDownsellLevel1: (vehicleType) => {
                        const features = packageFeatures["Level 1 Detail"][vehicleType].join(', ');
                        const price = packagePrices[recommendedPackageType][vehicleType];
                        return `I completely understand! We have another option that will fit your budget and your needs. I'm going to recommend our most affordable option, it's called level 1 detail service. It includes ${features}. The price is $${price}, does that sound good?`;
                    },
                    schedulingVehicleType: "Excellent! To help me find the best appointment for you, what type of vehicle are we scheduling for? Is it a car, truck, or SUV?",
                    schedulingPackageInquiry: (vehicleType) => {
                        const carPrices = `Level 1 Detail at $${packagePrices["Level 1 Detail"].car}, Level 2 at $${packagePrices["Level 2 Detail"].car}, and Level 3 at $${packagePrices["Level 3 Detail"].car}`;
                        const suvTruckPrices = `Level 1 at $${packagePrices["Level 1 Detail"]["suv-truck"]}, Level 2 at $${packagePrices["Level 2 Detail"]["suv-truck"]}, and Level 3 at $${packagePrices["Level 3 Detail"]["suv-truck"]}`;
                        const prices = vehicleType === 'car' ? carPrices : suvTruckPrices;
                        return `Perfect. For a ${vehicleType}, we have our ${prices}. Which package are you interested in today?`;
                    },
                    bookingStepName: (packageName, vehicleType) => `Wonderful! You've selected the ${packageName} for a ${vehicleType}. First, what is your full name?`,
                    bookingStepContact: "And what is your best email address and phone number?",
                    bookingStepAddress: "Great! Where will we be performing the detail service? I'll need your full service address and zip code.",
                    bookingStepVehicle: "Almost there! Could you please tell me the year, make, and model of your vehicle?",
                    bookingStepDatetime: "Perfect! Now, let's find a convenient date and time for your appointment. What date works best for you?",
                    
                    // Manual SMS flow scripts
                    paymentOptionsQuestion: (customerName) => `Awesome ${customerName}, your appointment is almost confirmed, we just need to discuss payment options. Would you like to pay a $50 deposit now and the remainder after the service, or pay in full now?`,
                    payInFullSMS: (customerName, amount, vehicleDetails) => `Hi ${customerName}, it's Judy with Michie Auto Detail! Your appointment is almost confirmed, just make your payment of $${amount} for your auto detail on your ${vehicleDetails} as soon as that's done, you'll be all set!`,
                    depositSMS: (customerName, vehicleDetails) => `Hi ${customerName}, it's Judy with Michie Auto Detail! Your appointment is almost confirmed, just make your $50 deposit to secure your appointment slot for your auto detail on your ${vehicleDetails} as soon as that's done, you'll be all set!`,
                    didYouMakePaymentQuestion: (customerName, paymentType) => `${customerName} did you make your ${paymentType} already?`,
                    waitingForPayment: "Ok take your time. I'll wait while you make your payment.",
                    finalConfirmationScript: (customerName, date, time, vehicleDetails) => `Alright! You're all set! I'm sending you a confirmation text now for your appointment on ${date} and ${time}. Thank you for calling Michie Auto Detail, have a great day!`,
                    confirmationSMS: (date, time, vehicleDetails) => `Thank you for choosing Michie Auto Detail! Your appointment is confirmed on ${date} at ${time} for your ${vehicleDetails} Questions? Call (405) 295-5189`,
                    otherCallsNotes: "Okay, I'm ready to take notes for this call. What is your inquiry?"
                };

                const availableTimes = ['09:00', '11:00', '12:00', '14:00', '16:00', '17:00', '18:00'];

                const paymentLinks = {
                    "Level 1 Detail": { "149": "https://pay.michieauto.com/lvl1sedan", "199": "https://pay.michieauto.com/lvl1suv" },
                    "Level 2 Detail": { "249": "https://pay.michieauto.com/lvl2sedan", "299": "https://pay.michieauto.com/lvl2suv" },
                    "Level 3 Detail": { "349": "https://pay.michieauto.com/lvl3sedan", "399": "https://pay.michieauto.com/lvl3suv" },
                };
                
                const pageLoadTimeCST = new Date(new Date().toLocaleString('en-US', { timeZone: 'America/Chicago' }));

                async function apiCall(endpoint, method, payload = null) {
                    const headers = { 'Content-Type': 'application/json' };
                    const options = { method, headers };
                    if (payload) {
                        options.body = JSON.stringify(payload);
                    }
                    try {
                        const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
                        const responseText = await response.text(); // Always get text first

                        if (!response.ok) {
                            console.error(`API Call failed: ${response.status} ${response.statusText}`);
                            console.error('Response body:', responseText); // Log the actual response body
                            let errorMessage = `Server responded with status ${response.status}: ${response.statusText}.`;
                            try {
                                const errorData = JSON.parse(responseText);
                                errorMessage = errorData.message || errorMessage;
                            } catch (e) {
                                errorMessage = `Unexpected server response. Expected JSON, got HTML/text. Status: ${response.status}. Content: ${responseText.substring(0, 200)}...`;
                            }
                            throw new Error(errorMessage);
                        }

                        // If response is OK, try to parse as JSON. Handle empty responses.
                        const data = responseText ? JSON.parse(responseText) : {};
                        return { ok: response.ok, data: data, status: response.status };
                    } catch (error) {
                        console.error('API Call Error:', error);
                        return { ok: false, data: { message: error.message || 'Network error or invalid JSON response.' } };
                    }
                }
                
                function hideAllSections() {
                    // Hide all *major* sections
                    [elements.initialScriptSection, elements.pricingSection, elements.schedulingSection, elements.otherCallsSection, 
                    elements.confirmationSection, elements.paymentConfirmationQuestionSection, elements.waitingForPaymentManualSection, 
                    elements.finalConfirmationManualSection]
                        .forEach(el => el && (el.style.display = 'none'));
                    
                    // Hide all *sub-sections* within pricing and scheduling, ensuring a clean slate
                    [
                        elements.pricingVehicleTypeSelection, elements.pricingIntroLevels, elements.pricingPetHairQuestion,
                        elements.pricingShampooQuestion, elements.pricingLevel2Recommendation, elements.pricingLevel1Recommendation,
                        elements.pricingFullPackageDetails, elements.sedanPackagesDisplay, elements.suvTruckPackagesDisplay,
                        elements.schedulingVehicleTypeSelection, elements.schedulingPackageSelectionContainer,
                        elements.bookingFormSection, 
                        elements.bookingStepName, elements.bookingStepContact,
                        elements.bookingStepAddress, elements.bookingStepVehicle, elements.bookingStepDatetime,
                        elements.policyText, elements.passwordFields // Hide password fields too
                    ].forEach(el => el && (el.style.display = 'none'));

                    // Explicitly hide payment options buttons div as well
                    if (elements.paymentOptionsButtons) elements.paymentOptionsButtons.style.display = 'none';
                }

                function updateScript(text) {
                    if (elements.scriptDisplay) {
                        elements.scriptDisplay.innerHTML = text;
                    }
                }

                // --- Main Script Navigation ---
                function showInitialScript() {
                    hideAllSections();
                    updateScript(scriptContent.initial);
                    if (elements.initialScriptSection) elements.initialScriptSection.style.display = 'block';
                    // Reset global state variables when returning to initial script
                    currentVehicleType = '';
                    recommendedPackageType = '';
                    recommendedPackagePrice = 0;
                    finalBookingPayload = {}; // Clear stored booking data
                }

                // --- Pricing Flow Functions ---
                function showPricingVehicleTypeSelection() {
                    hideAllSections(); 
                    updateScript(scriptContent.pricingVehicleType);
                    if (elements.pricingSection) elements.pricingSection.style.display = 'block'; 
                    if (elements.pricingVehicleTypeSelection) elements.pricingVehicleTypeSelection.style.display = 'block'; 
                    document.querySelectorAll('#pricing-vehicle-type-selection .btn-primary.active').forEach(b => b.classList.remove('active'));
                    // Reset recommended package when starting pricing flow
                    recommendedPackageType = '';
                    recommendedPackagePrice = 0;
                }

                function showPricingIntroLevels(vehicleType, clickedButton) {
                    currentVehicleType = vehicleType;
                    hideAllSections(); 
                    updateScript(scriptContent.pricingIntroLevels);
                    if (elements.pricingSection) elements.pricingSection.style.display = 'block'; 
                    if (elements.pricingIntroLevels) elements.pricingIntroLevels.style.display = 'block'; 
                    document.querySelectorAll('#pricing-vehicle-type-selection .btn-primary.active').forEach(b => b.classList.remove('active'));
                    if (clickedButton) clickedButton.classList.add('active');
                }

                function showPricingPetHairQuestion() {
                    hideAllSections(); 
                    updateScript(scriptContent.pricingPetHairQuestion);
                    if (elements.pricingSection) elements.pricingSection.style.display = 'block'; 
                    if (elements.pricingPetHairQuestion) elements.pricingPetHairQuestion.style.display = 'block'; 
                }

                function showPricingShampooQuestion() {
                    hideAllSections(); 
                    updateScript(scriptContent.pricingShampooQuestion);
                    if (elements.pricingSection) elements.pricingSection.style.display = 'block'; 
                    if (elements.pricingShampooQuestion) elements.pricingShampooQuestion.style.display = 'block'; 
                }

                function showPricingLevel2Recommendation() {
                    recommendedPackageType = "Level 2 Detail";
                    recommendedPackagePrice = packagePrices[recommendedPackageType][currentVehicleType];
                    console.log('Recommended Level 2:', { recommendedPackageType, recommendedPackagePrice, currentVehicleType });
                    hideAllSections(); 
                    updateScript(scriptContent.pricingLevel2Recommendation(currentVehicleType));
                    if (elements.pricingSection) elements.pricingSection.style.display = 'block'; 
                    if (elements.pricingLevel2Recommendation) elements.pricingLevel2Recommendation.style.display = 'block'; 
                }

                function showPricingLevel1Recommendation(isDownsell = false) {
                    recommendedPackageType = "Level 1 Detail";
                    recommendedPackagePrice = packagePrices[recommendedPackageType][currentVehicleType];
                    console.log('Recommended Level 1:', { recommendedPackageType, recommendedPackagePrice, currentVehicleType });
                    hideAllSections(); 
                    if (isDownsell) {
                        updateScript(scriptContent.pricingDownsellLevel1(currentVehicleType));
                    } else {
                        updateScript(scriptContent.pricingLevel1Recommendation(currentVehicleType));
                    }
                    if (elements.pricingSection) elements.pricingSection.style.display = 'block'; 
                    if (elements.pricingLevel1Recommendation) elements.pricingLevel1Recommendation.style.display = 'block'; 
                }

                // --- Scheduling Flow Functions ---
                function showSchedulingVehicleTypeSelection() {
                    hideAllSections(); // Start by hiding everything
                    updateScript(scriptContent.schedulingVehicleType);
                    if (elements.schedulingSection) elements.schedulingSection.style.display = 'block'; // Show scheduling section
                    if (elements.schedulingVehicleTypeSelection) elements.schedulingVehicleTypeSelection.style.display = 'block'; // Show vehicle type selection

                    document.querySelectorAll('#scheduling-vehicle-type-selection .btn-primary.active').forEach(b => b.classList.remove('active'));
                    // Clear any previously selected package/time
                    if (elements.selectedPackageTypeInput) elements.selectedPackageTypeInput.value = '';
                    if (elements.selectedPackagePriceInput) elements.selectedPackagePriceInput.value = '';
                    if (elements.selectedBookingTimeInput) elements.selectedBookingTimeInput.value = '';
                    if (elements.finalBookAppointmentBtn) elements.finalBookAppointmentBtn.style.display = 'none';
                    // Reset global state variables for scheduling flow
                    currentVehicleType = '';
                    recommendedPackageType = ''; 
                    recommendedPackagePrice = 0; 
                }

                function showSchedulingPackageSelection(vehicleCategory, clickedButton) {
                    currentVehicleType = vehicleCategory; 
                    hideAllSections(); 
                    if (elements.schedulingSection) elements.schedulingSection.style.display = 'block'; 
                    if (elements.schedulingPackageSelectionContainer) elements.schedulingPackageSelectionContainer.style.display = 'block'; 

                    updateScript(scriptContent.schedulingPackageInquiry(vehicleCategory));

                    document.querySelectorAll('#scheduling-vehicle-type-selection .btn-primary.active').forEach(b => b.classList.remove('active'));
                    if (clickedButton) clickedButton.classList.add('active');

                    if (elements.sedanPackagesBookingDisplay) elements.sedanPackagesBookingDisplay.style.display = vehicleCategory === 'car' ? 'grid' : 'none';
                    if (elements.suvTruckPackagesBookingDisplay) elements.suvTruckPackagesBookingDisplay.style.display = vehicleCategory === 'suv-truck' ? 'grid' : 'none';
                }

                // Functions for sequential booking form steps
                function showBookingStepName(packageType, packagePrice, vehicleType) {
                    console.log('Entering showBookingStepName with:', { packageType, packagePrice, vehicleType });
                    // Set package and vehicle type in hidden inputs
                    if (elements.selectedPackageDisplay) elements.selectedPackageDisplay.textContent = packageType;
                    if (elements.selectedPackageTypeInput) elements.selectedPackageTypeInput.value = packageType;
                    if (elements.selectedPackagePriceInput) elements.selectedPackagePriceInput.value = packagePrice;
                    if (elements.selectedVehicleTypeInput) elements.selectedVehicleTypeInput.value = vehicleType;

                    hideAllSections(); // Hide everything first

                    // Ensure the main scheduling section and booking form container are visible
                    if (elements.schedulingSection) elements.schedulingSection.style.display = 'block';
                    if (elements.bookingFormSection) elements.bookingFormSection.style.display = 'block';
                    
                    // Show only the current step
                    if (elements.bookingStepName) elements.bookingStepName.style.display = 'block';
                    
                    updateScript(scriptContent.bookingStepName(packageType, vehicleType));
                }

                function showBookingStepContact() {
                    // Validate name before proceeding
                    const fullName = document.getElementById('full-name').value;
                    if (!fullName) {
                        elements.bookingMessage.textContent = 'Please enter the full name.';
                        elements.bookingMessage.style.color = 'red';
                        return;
                    }
                    elements.bookingMessage.textContent = ''; // Clear previous message

                    if (elements.bookingStepName) elements.bookingStepName.style.display = 'none';
                    if (elements.bookingStepContact) elements.bookingStepContact.style.display = 'block';
                    updateScript(scriptContent.bookingStepContact);
                }

                function showBookingStepAddress() {
                    // Validate email and phone before proceeding
                    const email = document.getElementById('email').value;
                    const phone = document.getElementById('phone').value;
                    
                    // Email validation
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!email) {
                        elements.bookingMessage.textContent = 'Please enter your email address.';
                        elements.bookingMessage.style.color = 'red';
                        return;
                    }
                    if (!emailRegex.test(email)) {
                        elements.bookingMessage.textContent = 'Please enter a valid email address.';
                        elements.bookingMessage.style.color = 'red';
                        return;
                    }

                    // Phone number validation (10 digits, optional hyphens/spaces/parentheses)
                    const phoneRegex = /^\(?([0-9]{3})\)?[-. ]?([0-9]{3})[-. ]?([0-9]{4})$/;
                    if (!phone) {
                        elements.bookingMessage.textContent = 'Please enter your phone number.';
                        elements.bookingMessage.style.color = 'red';
                        return;
                    }
                    if (!phoneRegex.test(phone)) {
                        elements.bookingMessage.textContent = 'Please enter a valid 10-digit phone number.';
                        elements.bookingMessage.style.color = 'red';
                        return;
                    }

                    elements.bookingMessage.textContent = ''; // Clear previous message

                    if (elements.bookingStepContact) elements.bookingStepContact.style.display = 'none';
                    if (elements.bookingStepAddress) elements.bookingStepAddress.style.display = 'block';
                    updateScript(scriptContent.bookingStepAddress);

                    // Initialize Google Places Autocomplete when address input becomes visible
                    const addressInput = document.getElementById('address-input');
                    if (window.google && window.google.maps && window.google.maps.places && addressInput) {
                        console.log("Initializing Google Places Autocomplete for address-input.");
                        let addressAutocomplete = new google.maps.places.Autocomplete(addressInput, {
                            componentRestrictions: { country: "us" },
                            fields: ["formatted_address", "address_components"],
                            types: ["address"],
                        });
                        addressAutocomplete.addListener('place_changed', () => {
                            const place = addressAutocomplete.getPlace(); 
                            if (place.formatted_address) {
                                addressInput.value = place.formatted_address;
                                fillAddressFields(place, 'zip-code');
                            }
                        });
                    } else {
                        console.warn("Google Maps Autocomplete could not be initialized for address-input. API not loaded or element not found.");
                    }
                }

                function showBookingStepVehicle() {
                    // Validate address and zip before proceeding
                    const address = document.getElementById('address-input').value;
                    const zipCode = document.getElementById('zip-code').value;
                    if (!address || !zipCode) {
                        elements.bookingMessage.textContent = 'Please enter both address and zip code.';
                        elements.bookingMessage.style.color = 'red';
                        return;
                    }
                    elements.bookingMessage.textContent = ''; // Clear previous message

                    if (elements.bookingStepAddress) elements.bookingStepAddress.style.display = 'none';
                    if (elements.bookingStepVehicle) elements.bookingStepVehicle.style.display = 'block';
                    updateScript(scriptContent.bookingStepVehicle);
                }

                function showBookingStepDatetime() {
                    // Validate vehicle details before proceeding
                    const vehicleYear = document.getElementById('vehicle-year').value;
                    const vehicleMake = document.getElementById('vehicle-make').value;
                    const vehicleModel = document.getElementById('vehicle-model').value;
                    
                    if (!vehicleYear || !vehicleMake || !vehicleModel) {
                        elements.bookingMessage.textContent = 'Please enter vehicle year, make, and model.';
                        elements.bookingMessage.style.color = 'red';
                        return;
                    }
                    
                    // Validate password if create account is checked
                    const createAccount = elements.createAccountCheckbox.checked;
                    if (createAccount) {
                        if (!validatePassword() || !checkPasswordsMatch()) {
                            elements.bookingMessage.textContent = 'Please fix password errors.';
                            elements.bookingMessage.style.color = 'red';
                            return;
                        }
                    }

                    elements.bookingMessage.textContent = ''; // Clear previous message

                    if (elements.bookingStepVehicle) elements.bookingStepVehicle.style.display = 'none';
                    if (elements.bookingStepDatetime) elements.bookingStepDatetime.style.display = 'block';
                    updateScript(scriptContent.bookingStepDatetime);
                    checkAndSetInitialDate(); // Populate date and time slots
                    // Ensure the final book appointment button is visible on this step
                    if (elements.finalBookAppointmentBtn) elements.finalBookAppointmentBtn.style.display = 'block';
                }

                // This function now collects data and transitions, but DOES NOT book yet.
                async function collectBookingDataAndProceed(e, messageEl, selectedTimeInputId) { 
                    const submitButton = elements.finalBookAppointmentBtn;

                    submitButton.disabled = true;
                    submitButton.innerHTML = `
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Collecting Data...
                    `;

                    const restoreButton = () => {
                        submitButton.disabled = false;
                        submitButton.innerHTML = 'Book Appointment';
                    };

                    try {
                        // Collect all data from the various steps
                        const fullName = document.getElementById('full-name').value;
                        const email = document.getElementById('email').value;
                        const phone = document.getElementById('phone').value;
                        const address = document.getElementById('address-input').value;
                        const zipCode = document.getElementById('zip-code').value;
                        const vehicleYear = document.getElementById('vehicle-year').value;
                        const vehicleMake = document.getElementById('vehicle-make').value;
                        const vehicleModel = document.getElementById('vehicle-model').value;
                        const bookingDate = document.getElementById('booking-date').value;
                        const selectedTime = document.getElementById(selectedTimeInputId).value; 
                        const packageType = elements.selectedPackageTypeInput.value; 
                        const packagePrice = elements.selectedPackagePriceInput.value; 
                        const selectedVehicleType = elements.selectedVehicleTypeInput.value; 
                        
                        // Get create account and password data
                        const createAccount = elements.createAccountCheckbox ? elements.createAccountCheckbox.checked : false;
                        let password = '';
                        if (createAccount) {
                            password = elements.passwordInput ? elements.passwordInput.value : '';
                        }

                        // Basic validation (more robust validation could be added per step)
                        if (!fullName || !email || !phone || !address || !zipCode || !vehicleYear || !vehicleMake || !vehicleModel || !bookingDate || !selectedTime || !packageType || !packagePrice || !selectedVehicleType) {
                            if (messageEl) { messageEl.textContent = 'Please complete all required fields.'; messageEl.style.color = 'red'; }
                            restoreButton();
                            return;
                        }
                        // Email validation
                        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                        if (!emailRegex.test(email)) {
                            if (messageEl) { elements.bookingMessage.textContent = 'Please enter a valid email address.'; elements.bookingMessage.style.color = 'red'; }
                            restoreButton();
                            return;
                        }
                        // Phone number validation (10 digits, optional hyphens/spaces/parentheses)
                        const phoneRegex = /^\(?([0-9]{3})\)?[-. ]?([0-9]{3})[-. ]?([0-9]{4})$/;
                        if (!phoneRegex.test(phone)) {
                            if (messageEl) { elements.bookingMessage.textContent = 'Please enter a valid 10-digit phone number.'; elements.bookingMessage.style.color = 'red'; }
                            restoreButton();
                            return;
                        }
                        // Password validation if creating an account
                        if (createAccount) {
                            if (!validatePassword() || !checkPasswordsMatch()) {
                                if (messageEl) { elements.bookingMessage.textContent = 'Please fix password errors.'; elements.bookingMessage.style.color = 'red'; }
                                restoreButton();
                                return;
                            }
                        }

                        // Store ALL collected data in finalBookingPayload
                        finalBookingPayload = {
                            full_name: fullName, 
                            email: email, 
                            phone: phone, 
                            address: address, 
                            zip_code: zipCode, 
                            vehicle_year: vehicleYear,
                            vehicle_make: vehicleMake, 
                            vehicle_model: vehicleModel, 
                            date: bookingDate, 
                            time: selectedTime,
                            package_type: packageType, 
                            package_price: packagePrice, 
                            vehicle_type: selectedVehicleType, 
                            deal_name: `${packageType || 'Unknown Package'} ${vehicleMake || ''} ${vehicleModel || ''}`,
                            offer_code: "CallCenterBooking", 
                            create_account: createAccount, 
                            password: password 
                        };

                        console.log("Booking data collected:", finalBookingPayload); 
                        
                        // Proceed to payment options screen without making API call yet
                        showPaymentOptionsScreen(); 
                        restoreButton(); // Restore button state after collecting data and moving on

                    } catch (error) {
                        console.error("An unexpected JavaScript error occurred during data collection:", error);
                        if (elements.bookingMessage) {
                            elements.bookingMessage.textContent = 'An unexpected error occurred. Please try again.';
                            elements.bookingMessage.style.color = 'red';
                        }
                        restoreButton();
                    }
                }

                // This function now performs the actual API call to book the appointment
                async function finalizeAppointmentBooking() {
                    const submitButton = elements.btnPaymentDoneManual; // Assuming this is the button triggering finalization

                    submitButton.disabled = true;
                    submitButton.innerHTML = `
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Finalizing Booking...
                    `;

                    const restoreButton = () => {
                        submitButton.disabled = false;
                        submitButton.innerHTML = 'Payment is Complete';
                    };

                    try {
                        if (Object.keys(finalBookingPayload).length === 0) {
                            console.error("Error: finalBookingPayload is empty. Cannot finalize booking.");
                            elements.scriptDisplay.innerHTML = `<p class="text-red-600">Booking data missing. Please restart the process.</p>`;
                            restoreButton();
                            return;
                        }

                        console.log("Attempting final API call with payload:", finalBookingPayload); 
                        const { ok, data } = await apiCall('/public/appointment', 'POST', finalBookingPayload);
                        console.log("Final API call response:", { ok, data }); 

                        if (ok) {
                            showFinalConfirmationManualScreen(); // Transition to the final confirmation screen
                        } else {
                            elements.scriptDisplay.innerHTML = `<p class="text-red-600">Failed to finalize booking: ${data.message || 'Unknown error'}. Please try again.</p>`;
                            restoreButton();
                        }
                    } catch (error) {
                        console.error("An unexpected JavaScript error occurred during booking finalization:", error);
                        elements.scriptDisplay.innerHTML = `<p class="text-red-600">An unexpected error occurred during booking finalization. Please try again.</p>`;
                        restoreButton();
                    }
                }


                // Show payment options screen (replaces SMS confirmation flow)
                function showPaymentOptionsScreen() {
                    hideAllSections(); // Hide everything first
                    
                    if (elements.confirmationSection) {
                        elements.confirmationSection.style.display = 'block';
                    }
                    if (elements.policyText) {
                        elements.policyText.style.display = 'block';
                    }
                    
                    const fullName = finalBookingPayload.full_name; // Use data from stored payload
                    const packagePrice = finalBookingPayload.package_price; // Use data from stored payload
                    // Update confirmation message div content
                    if (elements.confirmationMessageDiv) {
                        elements.confirmationMessageDiv.innerHTML = `
                            <p class="text-2xl font-bold mb-2">⚠️ IMPORTANT: Send Payment SMS!</p>
                            <p class="text-md mt-4">${scriptContent.paymentOptionsQuestion(fullName)}</p>
                        `;
                    }

                    // Show payment options buttons
                    if (elements.paymentOptionsButtons) {
                        elements.paymentOptionsButtons.style.display = 'flex'; 
                        elements.paymentOptionsButtons.classList.add('flex', 'flex-col', 'sm:flex-row', 'justify-center', 'gap-4');
                    }
                    
                    // Set payment button links based on selected package
                    const packageType = finalBookingPayload.package_type;
                    const packagePriceVal = finalBookingPayload.package_price; 
                    const vehicleMake = finalBookingPayload.vehicle_make;
                    const vehicleModel = finalBookingPayload.vehicle_model;
                    const vehicleDetails = `${vehicleMake} ${vehicleModel}`;
                    const customerPhone = finalBookingPayload.phone.replace(/\D/g, ''); // Clean phone number
                    
                    let payInFullLink = '#';
                    if (paymentLinks[packageType] && paymentLinks[packageType][String(packagePriceVal)]) {
                        payInFullLink = paymentLinks[packageType][String(packagePriceVal)];
                    }

                    // Generate pre-filled SMS messages
                    const payInFullSMSMessage = scriptContent.payInFullSMS(fullName, packagePriceVal, vehicleDetails);
                    const depositSMSMessage = scriptContent.depositSMS(fullName, vehicleDetails);

                    // Set onclick handlers for manual SMS sending
                    if (elements.payNowButton) {
                        elements.payNowButton.textContent = `Pay in full $${parseFloat(packagePriceVal).toFixed(0)}`;
                        elements.payNowButton.onclick = () => { 
                            window.open(`sms:+1${customerPhone}?body=${encodeURIComponent(payInFullSMSMessage)}`, '_blank');
                            // After opening SMS, transition to payment confirmation question
                            showPaymentConfirmationQuestion(fullName, "full payment");
                        };
                    }
                    if (elements.payDepositButton) {
                        elements.payDepositButton.onclick = () => { 
                            window.open(`sms:+1${customerPhone}?body=${encodeURIComponent(depositSMSMessage)}`, '_blank');
                            // After opening SMS, transition to payment confirmation question
                            showPaymentConfirmationQuestion(fullName, "deposit");
                        };
                    }
                }

                // NEW: Function to show "Did you make payment?" screen
                function showPaymentConfirmationQuestion(customerName, paymentType) {
                    hideAllSections();
                    if (elements.paymentConfirmationQuestionSection) elements.paymentConfirmationQuestionSection.style.display = 'block';
                    if (elements.paymentConfirmationQuestionMessage) {
                        elements.paymentConfirmationQuestionMessage.innerHTML = `<p>${scriptContent.didYouMakePaymentQuestion(customerName, paymentType)}</p>`;
                    }
                    updateScript(scriptContent.didYouMakePaymentQuestion(customerName, paymentType)); // Update main script display
                }

                // NEW: Function to show "Ok take your time." screen
                function showWaitingForPaymentManualScreen() {
                    hideAllSections();
                    if (elements.waitingForPaymentManualSection) elements.waitingForPaymentManualSection.style.display = 'block';
                    if (elements.waitingForPaymentManualMessage) {
                        elements.waitingForPaymentManualMessage.innerHTML = `<p>${scriptContent.waitingForPayment}</p>`;
                    }
                    updateScript(scriptContent.waitingForPayment); // Update main script display
                }

                // NEW: Function to show final confirmation screen before sending last SMS
                function showFinalConfirmationManualScreen() {
                    hideAllSections();
                    if (elements.finalConfirmationManualSection) elements.finalConfirmationManualSection.style.display = 'block';
                    
                    const fullName = finalBookingPayload.full_name;
                    const bookingDate = finalBookingPayload.date;
                    const bookingTime = finalBookingPayload.time;
                    const vehicleMake = finalBookingPayload.vehicle_make;
                    const vehicleModel = finalBookingPayload.vehicle_model;
                    const vehicleDetails = `${vehicleMake} ${vehicleModel}`;

                    if (elements.finalConfirmationManualMessage) {
                        elements.finalConfirmationManualMessage.innerHTML = `
                            <p>${scriptContent.finalConfirmationScript(fullName, formatFullDateDisplay(bookingDate), formatTimeDisplay(bookingTime), vehicleDetails)}</p>
                            <p class="mt-4 font-bold text-red-700">IMPORTANT: TEXT CUSTOMER THE MESSAGE THROUGH RING CENTRAL, and WAIT until payment is confirmed.</p>
                        `;
                    }
                    updateScript(scriptContent.finalConfirmationScript(fullName, formatFullDateDisplay(bookingDate), formatTimeDisplay(bookingTime), vehicleDetails)); // Update main script display
                    // Ensure send confirmation text button is visible, and end call is hidden initially
                    elements.btnSendConfirmationText.style.display = 'block';
                    elements.btnEndCall.style.display = 'none';
                }

                // --- Other Calls Flow Functions ---
                function showOtherCalls() {
                    hideAllSections(); 
                    updateScript(scriptContent.otherCallsNotes);
                    if (elements.otherCallsSection) elements.otherCallsSection.style.display = 'block'; 
                    if (elements.otherCallsNotes) elements.otherCallsNotes.value = ''; 
                }


                // --- Event Listeners for Main Script Buttons ---
                if (elements.btnPricing) elements.btnPricing.addEventListener('click', showPricingVehicleTypeSelection);
                if (elements.btnScheduling) elements.btnScheduling.addEventListener('click', showSchedulingVehicleTypeSelection);
                if (elements.btnOtherCalls) elements.btnOtherCalls.addEventListener('click', showOtherCalls);

                // --- Back Buttons Event Listeners ---
                if (elements.backToMainFromPricingVehicle) elements.backToMainFromPricingVehicle.addEventListener('click', showInitialScript);
                if (elements.backToPricingVehicleTypeFromIntro) elements.backToPricingVehicleTypeFromIntro.addEventListener('click', showPricingVehicleTypeSelection);
                if (elements.backToIntroLevelsFromPetHair) elements.backToIntroLevelsFromPetHair.addEventListener('click', () => showPricingIntroLevels(currentVehicleType));
                if (elements.backToPetHairFromShampoo) elements.backToPetHairFromShampoo.addEventListener('click', showPricingShampooQuestion);
                if (elements.backToShampooFromLevel2) elements.backToShampooFromLevel2.addEventListener('click', showPricingShampooQuestion);
                if (elements.backToLevel2FromLevel1) elements.backToLevel2FromLevel1.addEventListener('click', showPricingLevel2Recommendation); 
                
                if (elements.backToMainFromSchedulingVehicle) elements.backToMainFromSchedulingVehicle.addEventListener('click', showInitialScript);
                if (elements.backToSchedulingVehicleType) elements.backToSchedulingVehicleType.addEventListener('click', showSchedulingPackageSelection); // Changed to showPackageSelection
                if (elements.backToPackageSelection) elements.backToPackageSelection.addEventListener('click', () => {
                    // Reset form fields when going back from booking steps
                    document.getElementById('full-name').value = '';
                    document.getElementById('email').value = '';
                    document.getElementById('phone').value = '';
                    document.getElementById('address-input').value = '';
                    document.getElementById('zip-code').value = '';
                    document.getElementById('vehicle-year').value = '';
                    document.getElementById('vehicle-make').value = '';
                    document.getElementById('vehicle-model').value = '';
                    document.getElementById('booking-date').value = '';
                    elements.selectedBookingTimeInput.value = '';
                    if (elements.bookingMessage) elements.bookingMessage.textContent = ''; 
                    showSchedulingPackageSelection(elements.selectedVehicleTypeInput.value); 
                });
                if (elements.backToNameStep) elements.backToNameStep.addEventListener('click', () => {
                    if (elements.bookingStepContact) elements.bookingStepContact.style.display = 'none';
                    if (elements.bookingStepName) elements.bookingStepName.style.display = 'block';
                    updateScript(scriptContent.bookingStepName(elements.selectedPackageTypeInput.value, elements.selectedVehicleTypeInput.value));
                });
                if (elements.backToContactStep) elements.backToContactStep.addEventListener('click', () => {
                    if (elements.bookingStepAddress) elements.bookingStepAddress.style.display = 'none';
                    if (elements.bookingStepContact) elements.bookingStepContact.style.display = 'block';
                    updateScript(scriptContent.bookingStepContact);
                });
                if (elements.backToAddressStep) elements.backToAddressStep.addEventListener('click', () => {
                    if (elements.bookingStepVehicle) elements.bookingStepVehicle.style.display = 'none';
                    if (elements.bookingStepAddress) elements.bookingStepAddress.style.display = 'block';
                    updateScript(scriptContent.bookingStepAddress);
                });
                if (elements.backToVehicleStep) elements.backToVehicleStep.addEventListener('click', () => {
                    if (elements.bookingStepDatetime) elements.bookingStepDatetime.style.display = 'none';
                    if (elements.bookingStepVehicle) elements.bookingStepVehicle.style.display = 'block';
                    updateScript(scriptContent.bookingStepVehicle);
                });

                if (elements.backToMainFromConfirmation) elements.backToMainFromConfirmation.addEventListener('click', showInitialScript);
                if (elements.backToMainFromOther) elements.backToMainFromOther.addEventListener('click', showInitialScript);


                // --- Pricing Section Specific Event Listeners ---
                if (elements.pricingSelectCarBtn) elements.pricingSelectCarBtn.addEventListener('click', (e) => showPricingIntroLevels('car', e.target));
                if (elements.pricingSelectTruckBtn) elements.pricingSelectTruckBtn.addEventListener('click', (e) => showPricingIntroLevels('suv-truck', e.target));
                if (elements.pricingSelectSuvBtn) elements.pricingSelectSuvBtn.addEventListener('click', (e) => showPricingIntroLevels('suv-truck', e.target));

                if (elements.btnOkIntroLevels) elements.btnOkIntroLevels.addEventListener('click', showPricingPetHairQuestion);
                
                if (elements.btnPetHairYes) elements.btnPetHairYes.addEventListener('click', showPricingLevel2Recommendation);
                if (elements.btnPetHairNo) elements.btnPetHairNo.addEventListener('click', showPricingShampooQuestion);

                if (elements.btnShampooYes) elements.btnShampooYes.addEventListener('click', showPricingLevel2Recommendation);
                if (elements.btnShampooNo) elements.btnShampooNo.addEventListener('click', () => showPricingLevel1Recommendation(false)); 

                if (elements.btnLevel2Yes) elements.btnLevel2Yes.addEventListener('click', () => {
                    console.log('btnLevel2Yes clicked. Calling showBookingStepName with:', { recommendedPackageType, recommendedPackagePrice, currentVehicleType });
                    elements.pricingLevel2Recommendation.style.display = 'none';
                    elements.pricingLevel1Recommendation.style.display = 'none';
                    elements.pricingSection.style.display = 'none'; 
                    showBookingStepName(recommendedPackageType, recommendedPackagePrice, currentVehicleType); 
                });
                if (elements.btnLevel2No) elements.btnLevel2No.addEventListener('click', () => showPricingLevel1Recommendation(true)); 

                if (elements.btnLevel1Yes) elements.btnLevel1Yes.addEventListener('click', () => {
                    console.log('btnLevel1Yes clicked. Calling showBookingStepName with:', { recommendedPackageType, recommendedPackagePrice, currentVehicleType });
                    elements.pricingLevel2Recommendation.style.display = 'none';
                    elements.pricingLevel1Recommendation.style.display = 'none';
                    elements.pricingSection.style.display = 'none'; 
                    showBookingStepName(recommendedPackageType, recommendedPackagePrice, currentVehicleType); 
                });
                if (elements.btnLevel1No) elements.btnLevel1No.addEventListener('click', showOtherCalls);


                // Package dropdown toggles in pricing section (for reference details)
                if (elements.pricingSection) elements.pricingSection.addEventListener('click', (e) => {
                    if (e.target.classList.contains('see-whats-included-btn')) {
                        const targetId = e.target.dataset.target;
                        const dropdown = document.getElementById(targetId);
                        if (dropdown) {
                            dropdown.classList.toggle('show');
                            e.target.textContent = dropdown.classList.contains('show') ? 'Hide details' : "See what's included";
                        }
                    }
                });
                if (elements.togglePricingSedan) elements.togglePricingSedan.addEventListener('click', () => {
                    if (elements.sedanPackagesDisplay) elements.sedanPackagesDisplay.style.display = 'grid';
                    if (elements.suvTruckPackagesDisplay) elements.suvTruckPackagesDisplay.style.display = 'none';
                });
                if (elements.togglePricingSuvTruck) elements.togglePricingSuvTruck.addEventListener('click', () => {
                    if (elements.sedanPackagesDisplay) elements.sedanPackagesDisplay.style.display = 'none';
                    if (elements.suvTruckPackagesDisplay) elements.suvTruckPackagesDisplay.style.display = 'grid';
                });


                // --- Scheduling Flow Logic (unchanged from previous version, but integrated) ---
                if (elements.schedulingSelectCarBtn) elements.schedulingSelectCarBtn.addEventListener('click', (e) => {
                    showSchedulingPackageSelection('car', e.target);
                });
                if (elements.schedulingSelectTruckBtn) elements.schedulingSelectTruckBtn.addEventListener('click', (e) => {
                    showSchedulingPackageSelection('suv-truck', e.target);
                });
                if (elements.schedulingSelectSuvBtn) elements.schedulingSelectSuvBtn.addEventListener('click', (e) => {
                    showSchedulingPackageSelection('suv-truck', e.target);
                });

                if (elements.schedulingSection) elements.schedulingSection.addEventListener('click', (e) => {
                    if (e.target.closest('.select-package-btn')) {
                        const button = e.target.closest('.select-package-btn');
                        const packageType = button.dataset.packageType;
                        const packagePrice = button.dataset.packagePrice;
                        const vehicleType = button.dataset.vehicleType; 
                        console.log('Scheduling select-package-btn clicked. Calling showBookingStepName with:', { packageType, packagePrice, vehicleType });
                        showBookingStepName(packageType, packagePrice, vehicleType); 
                    }
                });

                // Universal event listener for "See what's included" buttons
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('see-whats-included-btn')) {
                        const targetId = e.target.dataset.target;
                        const dropdown = document.getElementById(targetId);
                        if (dropdown) {
                            dropdown.classList.toggle('show');
                            e.target.textContent = dropdown.classList.contains('show') ? 'Hide details' : "See what's included";
                        }
                    }
                });


                // Event listeners for "Next" buttons in booking steps
                if (elements.btnNextName) elements.btnNextName.addEventListener('click', showBookingStepContact);
                if (elements.btnNextContact) elements.btnNextContact.addEventListener('click', showBookingStepAddress);
                if (elements.btnNextAddress) elements.btnNextAddress.addEventListener('click', showBookingStepVehicle);
                if (elements.btnNextVehicle) elements.btnNextVehicle.addEventListener('click', showBookingStepDatetime);
                
                // Final form submission (from booking-step-datetime)
                // This now collects data and transitions, but does NOT book yet.
                if (elements.finalBookAppointmentBtn) {
                    elements.finalBookAppointmentBtn.addEventListener('click', (e) => {
                        e.preventDefault(); 
                        collectBookingDataAndProceed(e, elements.bookingMessage, 'selected-booking-time');
                    });
                }

                // NEW: Payment confirmation question buttons logic
                if (elements.btnPaymentConfirmedYes) {
                    elements.btnPaymentConfirmedYes.addEventListener('click', () => {
                        showFinalConfirmationManualScreen();
                    });
                }

                if (elements.btnPaymentConfirmedNo) {
                    elements.btnPaymentConfirmedNo.addEventListener('click', () => {
                        showWaitingForPaymentManualScreen();
                    });
                }

                // NEW: Waiting for payment "Payment is Complete" button logic
                if (elements.btnPaymentDoneManual) {
                    elements.btnPaymentDoneManual.addEventListener('click', () => {
                        finalizeAppointmentBooking(); // This is where the actual API call happens
                    });
                }

                // NEW: Final confirmation "Send Confirmation Text" button logic
                if (elements.btnSendConfirmationText) {
                    elements.btnSendConfirmationText.addEventListener('click', () => {
                        const fullName = finalBookingPayload.full_name;
                        const customerPhone = finalBookingPayload.phone.replace(/\D/g, '');
                        const bookingDate = finalBookingPayload.date;
                        const bookingTime = finalBookingPayload.time;
                        const vehicleMake = finalBookingPayload.vehicle_make;
                        const vehicleModel = finalBookingPayload.vehicle_model;
                        const vehicleDetails = `${vehicleMake} ${vehicleModel}`;

                        const confirmationSMSMessage = scriptContent.confirmationSMS(formatFullDateDisplay(bookingDate), formatTimeDisplay(bookingTime), vehicleDetails);
                        window.open(`sms:+1${customerPhone}?body=${encodeURIComponent(confirmationSMSMessage)}`, '_blank');
                        // After sending, agent can end call
                        elements.btnEndCall.style.display = 'block'; // Show end call button
                        elements.btnSendConfirmationText.style.display = 'none'; // Hide send button
                        updateScript("Confirmation text sent! You can now end the call.");
                    });
                }

                // NEW: Final confirmation "End Call" button logic
                if (elements.btnEndCall) {
                    elements.btnEndCall.addEventListener('click', showInitialScript);
                }

                // Password fields logic
                if (elements.createAccountCheckbox) {
                    elements.createAccountCheckbox.addEventListener('change', () => {
                        if (elements.passwordFields) {
                            elements.passwordFields.style.display = elements.createAccountCheckbox.checked ? 'block' : 'none';
                            if (!elements.createAccountCheckbox.checked) {
                                if (elements.passwordInput) elements.passwordInput.value = '';
                                if (elements.confirmPasswordInput) elements.confirmPasswordInput.value = '';
                                if (elements.passwordMatchMessage) elements.passwordMatchMessage.classList.add('hidden');
                                if (elements.passwordLengthReq) elements.passwordLengthReq.classList.remove('valid', 'invalid');
                                if (elements.passwordUppercaseReq) elements.passwordUppercaseReq.classList.remove('valid', 'invalid');
                            }
                        }
                    });
                }

                if (elements.passwordInput) elements.passwordInput.addEventListener('input', validatePassword);
                if (elements.passwordInput) elements.passwordInput.addEventListener('input', checkPasswordsMatch);
                if (elements.confirmPasswordInput) elements.confirmPasswordInput.addEventListener('input', checkPasswordsMatch);

                function validatePassword() {
                    const password = elements.passwordInput ? elements.passwordInput.value : '';
                    const isLengthValid = password.length >= 6;
                    const hasUppercase = /[A-Z]/.test(password);
                    if (elements.passwordLengthReq) elements.passwordLengthReq.classList.toggle('valid', isLengthValid);
                    if (elements.passwordLengthReq) elements.passwordLengthReq.classList.toggle('invalid', !isLengthValid);
                    if (elements.passwordUppercaseReq) elements.passwordUppercaseReq.classList.toggle('valid', hasUppercase);
                    if (elements.passwordUppercaseReq) elements.passwordUppercaseReq.classList.toggle('invalid', !hasUppercase);
                    return isLengthValid && hasUppercase;
                }

                function checkPasswordsMatch() {
                    const password = elements.passwordInput ? elements.passwordInput.value : '';
                    const confirmPassword = elements.confirmPasswordInput ? elements.confirmPasswordInput.value : '';
                    if (elements.passwordMatchMessage) elements.passwordMatchMessage.classList.toggle('hidden', password === confirmPassword);
                    return password === confirmPassword;
                }
                
                function renderTimeButtons(container, hiddenInput, selectedDateStr, finalBookButton, now) {
                    if (!container) return false;
                    container.innerHTML = '';
                
                    let hasAvailableSlots = false;
                    const twoHoursInMs = 2 * 60 * 60 * 1000;
                    const comparisonTime = new Date(now.getTime() + twoHoursInMs);
                
                    const selectedDate = new Date(selectedDateStr + 'T00:00:00-05:00'); // Assuming CST/CDT
                    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                
                    const isToday = selectedDate.getTime() === today.getTime();
                
                    availableTimes.forEach(time => {
                        const button = document.createElement('button');
                        button.type = 'button';
                        button.textContent = formatTimeDisplay(time);
                        button.dataset.time = time;
                
                        const [hour, minute] = time.split(':').map(Number);
                        const appointmentDateTime = new Date(selectedDate);
                        appointmentDateTime.setHours(hour, minute);
                
                        const isDisabled = isToday && (appointmentDateTime < comparisonTime);
                
                        if (isDisabled) {
                            button.className = 'time-button disabled';
                            button.disabled = true;
                        } else {
                            hasAvailableSlots = true;
                            button.className = 'time-button';
                            button.addEventListener('click', () => {
                                const currentlySelected = container.querySelector('.time-button.selected');
                                if (currentlySelected) currentlySelected.classList.remove('selected');
                                button.classList.add('selected');
                                if (hiddenInput) hiddenInput.value = time;
                            });
                        }
                        container.appendChild(button);
                    });
                
                    if (hiddenInput) hiddenInput.value = '';
                    return hasAvailableSlots;
                }

                function checkAndSetInitialDate() {
                    const today = new Date(pageLoadTimeCST);
                    const todayFormatted = today.toISOString().split('T')[0];

                    const todayHasSlots = renderTimeButtons(elements.bookingTimeButtonsContainer, elements.selectedBookingTimeInput, todayFormatted, null, pageLoadTimeCST);

                    if (todayHasSlots) {
                        if (elements.bookingDateInput) {
                            elements.bookingDateInput.value = todayFormatted;
                        }
                    } else {
                        const tomorrow = new Date(today);
                        tomorrow.setDate(today.getDate() + 1);
                        const tomorrowFormatted = tomorrow.toISOString().split('T')[0];
                        
                        if (elements.bookingDateInput) {
                            elements.bookingDateInput.value = tomorrowFormatted;
                        }
                        renderTimeButtons(elements.bookingTimeButtonsContainer, elements.selectedBookingTimeInput, tomorrowFormatted, null, pageLoadTimeCST);
                    }
                }

                function formatTimeDisplay(time24hr) {
                    const [hours, minutes] = time24hr.split(':').map(Number); 
                    const date = new Date();
                    date.setHours(hours, minutes);
                    return date.toLocaleString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true });
                }

                function formatFullDateDisplay(dateStr) {
                    const date = new Date(dateStr + 'T00:00:00-05:00'); // Assuming CST/CDT
                    return date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                }
                
                const todayFormatted = new Date().toISOString().split('T')[0];
                if (elements.bookingDateInput) {
                    elements.bookingDateInput.min = todayFormatted;
                }

                // Initial display: show only the script section
                showInitialScript();

            } catch (e) {
                console.error("Error during application initialization:", e);
                // Display a user-friendly error message on the page itself
                const scriptDisplay = document.getElementById('script-display');
                if (scriptDisplay) {
                    scriptDisplay.innerHTML = `<p class="text-red-600">An error occurred during startup. Please try refreshing the page. Error: ${e.message}</p>`;
                }
                // Also ensure initial buttons are hidden if app failed to start
                const initialScriptSection = document.getElementById('initial-script-section');
                if (initialScriptSection) {
                    initialScriptSection.style.display = 'none';
                }
            }
        }

        // The Google Maps script will call window.initBookingPage, which is now our main app initialization.
        // No need for document.addEventListener('DOMContentLoaded', initializeApp); anymore.
        // The script tag for Google Maps should be the last thing loaded in the body to ensure DOM is ready.
    </script>
</body>
</html>
