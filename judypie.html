<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Michie Auto Detailing - Call Center Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #334155; }
        .pac-container { z-index: 1050 !important; }
        .btn { padding: 0.75rem 1.5rem; border-radius: 0.75rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; border: none; display: inline-flex; align-items: center; justify-content: center; text-align: center; }
        .btn-primary { background-color: #3b82f6; color: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .btn-primary:hover:not(:disabled) { background-color: #2563eb; transform: translateY(-2px); }
        .btn-secondary { background-color: #e2e8f0; color: #475569; border: 1px solid #cbd5e1; }
        .btn-secondary:hover:not(:disabled) { background-color: #cbd5e1; }
        .btn-success { background-color: #22c55e; color: white; }
        .btn-success:hover:not(:disabled) { background-color: #16a34a; transform: translateY(-2px); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .card { background-color: #ffffff; border-radius: 1rem; padding: 1.5rem; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05); }
        .form-input, .form-select { width: 100%; padding: 0.75rem 1rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; background-color: #ffffff; font-size: 1rem; color: #334155; transition: border-color 0.2s, box-shadow 0.2s; }
        .form-input:focus, .form-select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
        .form-label { display: block; font-weight: 500; margin-bottom: 0.5rem; color: #475569; }
        .script-display { background-color: #e0f2fe; border: 2px solid #90cdf4; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem; font-size: 1.125rem; font-weight: 500; color: #1e40af; text-align: center; min-height: 100px;}
        .time-button { padding: 0.75rem 1rem; border-radius: 0.75rem; border: 2px solid #cbd5e1; font-weight: 500; cursor: pointer; transition: all 0.2s ease; background-color: #e0f2fe; color: #1e40af; text-align: center; }
        .time-button:hover:not(:disabled) { background-color: #bfdbfe; border-color: #60a5fa; }
        .time-button.selected { background-color: #2563eb; color: white; border-color: #2563eb; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .time-button:disabled { background-color: #e2e8f0; color: #94a3b8; cursor: not-allowed; opacity: 0.7; }
    </style>
</head>
<body class="bg-gray-50">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-10">
            <img src="https://michieauto.com/logo.jpeg" alt="Michie Auto Detailing Logo" class="mx-auto mb-4 w-64 h-auto rounded-lg shadow-md" onerror="this.onerror=null;this.src='https://placehold.co/256x100/e2e8f0/334155?text=Michie+Auto';">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">Michie Auto Detailing Call Center</h1>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 lg:gap-8">
            <!-- Left Column: Interactive Script -->
            <div class="flex flex-col space-y-4">
                <div class="script-display" id="script-display"></div>
                <div id="script-container" class="card"></div>
            </div>

            <!-- Right Column: Static Form -->
            <div class="mt-8 lg:mt-0">
                <div class="card sticky top-8">
                    <h2 class="text-2xl font-bold text-gray-700 mb-6 border-b pb-4">Booking Summary</h2>
                    <form id="static-booking-form" class="space-y-4">
                        <div><label for="form-full-name" class="form-label">Full Name</label><input type="text" id="form-full-name" class="form-input bg-gray-100" readonly></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label for="form-email" class="form-label">Email Address</label><input type="email" id="form-email" class="form-input bg-gray-100" readonly></div>
                            <div><label for="form-phone" class="form-label">Phone Number</label><input type="tel" id="form-phone" class="form-input bg-gray-100" readonly></div>
                        </div>
                        <div><label for="form-address" class="form-label">Service Address</label><input type="text" id="form-address" class="form-input bg-gray-100" readonly></div>
                        <div class="pt-4 border-t"><h3 class="text-lg font-semibold text-gray-600 mb-2">Vehicle Details</h3><div class="grid grid-cols-1 md:grid-cols-3 gap-4"><div><label for="form-vehicle-type" class="form-label">Type</label><input type="text" id="form-vehicle-type" class="form-input bg-gray-100" readonly></div><div><label for="form-vehicle-year" class="form-label">Year</label><input type="text" id="form-vehicle-year" class="form-input bg-gray-100" readonly></div><div><label for="form-vehicle-make" class="form-label">Make</label><input type="text" id="form-vehicle-make" class="form-input bg-gray-100" readonly></div><div class="col-span-1 md:col-span-3"><label for="form-vehicle-model" class="form-label">Model</label><input type="text" id="form-vehicle-model" class="form-input bg-gray-100" readonly></div></div></div>
                        <div class="pt-4 border-t"><h3 class="text-lg font-semibold text-gray-600 mb-2">Appointment Details</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="form-package-type" class="form-label">Package</label><input type="text" id="form-package-type" class="form-input bg-gray-100" readonly></div><div><label for="form-package-price" class="form-label">Price</label><input type="text" id="form-package-price" class="form-input bg-gray-100" readonly></div><div><label for="form-booking-date" class="form-label">Date</label><input type="text" id="form-booking-date" class="form-input bg-gray-100" readonly></div><div><label for="form-booking-time" class="form-label">Time</label><input type="text" id="form-booking-time" class="form-input bg-gray-100" readonly></div></div></div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB133ISKHPtat18iloHDlqm2QHBv133sOk&libraries=places&callback=initApp" async defer></script>

    <script>
    function initApp() {
        const API_URL = 'https://michie-detailing-admin.onrender.com/public/appointment';
        const elements = { scriptDisplay: document.getElementById('script-display'), scriptContainer: document.getElementById('script-container') };
        let state = {};

        const scripts = {
            initial: "Thank you for calling Michie Auto Detailing. Are you calling about pricing or to schedule an appointment?",
            pricingVehicleType: "I can certainly help with pricing. What type of vehicle is it?",
            pricingIntro: "We have 3 levels of service. I'll ask a couple of questions to see which is right for you, sound good?",
            pricingPetHair: "Do you have any pet hair in your vehicle?",
            pricingShampoo: "Would you like your seats and carpets shampooed?",
            pricingLevel2Rec: (price) => `Based on your answers, I recommend our most popular option, the Level 2 Detail. It includes a full interior and exterior cleaning with shampoo for just $${price}. Does that sound good?`,
            pricingLevel1Rec: (price) => `Okay, in that case I'd recommend our Level 1 Detail. It's a thorough interior and exterior cleaning for just $${price}. Does that sound good?`,
            schedulingVehicleType: "Excellent! To schedule, what type of vehicle is it?",
            bookingForm: "Perfect. Please provide the customer's details to find an appointment.",
            otherCalls: "Okay, I'm ready to take notes. What is the call regarding?"
        };

        const prices = { car: { 1: 149, 2: 249, 3: 349 }, suv_truck: { 1: 199, 2: 299, 3: 399 } };
        const updateScript = (text) => { elements.scriptDisplay.innerHTML = text; };
        const formatTime = (t) => { if (!t) return ''; const [h, m] = t.split(':'); return new Date(0,0,0,h,m).toLocaleTimeString('en-US', {hour:'numeric', minute:'2-digit'}); };
        const formatDate = (d) => { if (!d) return ''; return new Date(d+'T12:00:00').toLocaleDateString('en-US', {weekday:'long',month:'long',day:'numeric',year:'numeric'}); };
        
        const initGoogleAutocomplete = () => {
            const addressInput = document.getElementById('address');
            if (addressInput && window.google?.maps?.places) {
                const autocomplete = new google.maps.places.Autocomplete(addressInput, { componentRestrictions: { country: "us" }, fields: ["address_components", "formatted_address"], types: ["address"] });
                autocomplete.addListener('place_changed', () => {
                    const place = autocomplete.getPlace();
                    if (place.formatted_address) addressInput.value = place.formatted_address;
                    const zip = place.address_components?.find(c => c.types.includes('postal_code'))?.long_name || '';
                    const zipInput = document.getElementById('zip_code');
                    if (zipInput) zipInput.value = zip;
                });
            }
        };

        const renderView = (view) => {
            elements.scriptContainer.innerHTML = '';
            let content = '';

            const createButton = (id, text, style, wFull = true) => `<button id="${id}" class="btn ${style} ${wFull ? 'w-full' : ''}">${text}</button>`;
            const createButtonGroup = (buttons) => `<div class="space-y-4 p-4">${buttons.join('')}</div>`;

            switch (view) {
                case 'initial':
                    updateScript(scripts.initial);
                    content = createButtonGroup([
                        createButton('btn-scheduling', 'Schedule Appointment', 'btn-primary'),
                        createButton('btn-pricing', 'Pricing Question', 'btn-secondary')
                    ]);
                    break;
                
                case 'pricingVehicleType':
                    updateScript(scripts.pricingVehicleType);
                    content = createButtonGroup([
                        createButton('btn-car', 'Car', 'btn-primary'),
                        createButton('btn-suv', 'SUV / Truck', 'btn-primary'),
                        createButton('btn-back-initial', 'Back', 'btn-secondary mt-4')
                    ]);
                    break;

                case 'pricingIntro':
                    updateScript(scripts.pricingIntro);
                    content = createButtonGroup([
                        createButton('btn-ok', 'OK', 'btn-primary'),
                        createButton('btn-back-pricing-vehicle', 'Back', 'btn-secondary mt-4')
                    ]);
                    break;
                
                case 'pricingPetHair':
                    updateScript(scripts.pricingPetHair);
                    content = createButtonGroup([
                        createButton('btn-yes', 'Yes', 'btn-primary'),
                        createButton('btn-no', 'No', 'btn-primary'),
                        createButton('btn-back-pricing-intro', 'Back', 'btn-secondary mt-4')
                    ]);
                    break;

                case 'pricingShampoo':
                    updateScript(scripts.pricingShampoo);
                    content = createButtonGroup([
                        createButton('btn-yes', 'Yes', 'btn-primary'),
                        createButton('btn-no', 'No', 'btn-primary'),
                        createButton('btn-back-pet-hair', 'Back', 'btn-secondary mt-4')
                    ]);
                    break;
                
                case 'pricingRecommendation':
                    const price = prices[state.vehicleSize][state.recLevel];
                    updateScript(state.recLevel === 2 ? scripts.pricingLevel2Rec(price) : scripts.pricingLevel1Rec(price));
                    content = createButtonGroup([
                        createButton('btn-schedule-it', 'Yes, Schedule It!', 'btn-success'),
                        createButton('btn-no-thanks', 'No, Thanks', 'btn-secondary')
                    ]);
                    break;

                case 'schedulingVehicleType':
                    updateScript(scripts.schedulingVehicleType);
                    content = createButtonGroup([
                        createButton('btn-car', 'Car', 'btn-primary'),
                        createButton('btn-suv', 'SUV / Truck', 'btn-primary'),
                        createButton('btn-back-initial', 'Back', 'btn-secondary mt-4')
                    ]);
                    break;

                case 'bookingForm':
                    updateScript(scripts.bookingForm);
                    content = `
                        <div class="space-y-4 p-4">
                            <div><label class="form-label">Full Name</label><input type="text" id="full_name" class="form-input"></div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label class="form-label">Email</label><input type="email" id="email" class="form-input"></div>
                                <div><label class="form-label">Phone</label><input type="tel" id="phone" class="form-input"></div>
                            </div>
                            <div><label class="form-label">Address</label><input type="text" id="address" class="form-input"></div>
                            <div><label class="form-label">Zip Code</label><input type="text" id="zip_code" class="form-input"></div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div><label class="form-label">Veh. Year</label><input type="text" id="vehicle_year" class="form-input"></div>
                                <div><label class="form-label">Veh. Make</label><input type="text" id="vehicle_make" class="form-input"></div>
                                <div><label class="form-label">Veh. Model</label><input type="text" id="vehicle_model" class="form-input"></div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label class="form-label">Package</label><input type="text" id="package_type" class="form-input" value="${state.package_type || ''}"></div>
                                <div><label class="form-label">Price ($)</label><input type="number" id="package_price" class="form-input" value="${state.package_price || ''}"></div>
                            </div>
                            <div><label class="form-label">Date</label><input type="date" id="date" class="form-input"></div>
                            <div><label class="form-label">Time</label><div id="booking-time-buttons" class="grid grid-cols-3 gap-2"></div><input type="hidden" id="time"></div>
                            <div class="pt-4 border-t"><label class="flex items-center"><input type="checkbox" id="create_account" class="h-4 w-4 rounded mr-2">Create Account (Optional)</label></div>
                            <div id="password-field" class="hidden"><label class="form-label">Password</label><input type="password" id="password" class="form-input"></div>
                            <button id="submit-btn" class="btn btn-success w-full mt-4">Submit Appointment</button>
                            <button id="back-to-vehicle" class="btn btn-secondary w-full mt-2">Back</button>
                        </div>`;
                    break;
            }
            elements.scriptContainer.innerHTML = content;
            attachListeners(view);
        };

        const attachListeners = (view) => {
            const el = (id) => document.getElementById(id);
            switch (view) {
                case 'initial':
                    el('btn-scheduling').addEventListener('click', () => renderView('schedulingVehicleType'));
                    el('btn-pricing').addEventListener('click', () => renderView('pricingVehicleType'));
                    break;
                case 'pricingVehicleType':
                    el('btn-car').addEventListener('click', () => { state.vehicleSize = 'car'; renderView('pricingIntro'); });
                    el('btn-suv').addEventListener('click', () => { state.vehicleSize = 'suv_truck'; renderView('pricingIntro'); });
                    el('btn-back-initial').addEventListener('click', () => renderView('initial'));
                    break;
                case 'pricingIntro':
                    el('btn-ok').addEventListener('click', () => renderView('pricingPetHair'));
                    el('btn-back-pricing-vehicle').addEventListener('click', () => renderView('pricingVehicleType'));
                    break;
                case 'pricingPetHair':
                    el('btn-yes').addEventListener('click', () => { state.recLevel = 2; renderView('pricingRecommendation'); });
                    el('btn-no').addEventListener('click', () => renderView('pricingShampoo'));
                    el('btn-back-pricing-intro').addEventListener('click', () => renderView('pricingIntro'));
                    break;
                case 'pricingShampoo':
                    el('btn-yes').addEventListener('click', () => { state.recLevel = 2; renderView('pricingRecommendation'); });
                    el('btn-no').addEventListener('click', () => { state.recLevel = 1; renderView('pricingRecommendation'); });
                    el('btn-back-pet-hair').addEventListener('click', () => renderView('pricingPetHair'));
                    break;
                case 'pricingRecommendation':
                    el('btn-schedule-it').addEventListener('click', () => {
                        state.package_type = `Level ${state.recLevel} Detail`;
                        state.package_price = prices[state.vehicleSize][state.recLevel];
                        renderView('bookingForm');
                    });
                    el('btn-no-thanks').addEventListener('click', () => renderView('initial'));
                    break;
                case 'schedulingVehicleType':
                    el('btn-car').addEventListener('click', () => { state.vehicle_type = 'Car'; renderView('bookingForm'); });
                    el('btn-suv').addEventListener('click', () => { state.vehicle_type = 'SUV/Truck'; renderView('bookingForm'); });
                    el('btn-back-initial').addEventListener('click', () => renderView('initial'));
                    break;
                case 'bookingForm':
                    initGoogleAutocomplete();
                    el('date').min = new Date().toISOString().split("T")[0];
                    const timeContainer = el('booking-time-buttons'), timeInput = el('time');
                    ['09:00', '11:00', '12:00', '14:00', '16:00', '17:00', '18:00'].forEach(t => {
                        const btn = document.createElement('button');
                        btn.type = 'button'; btn.className = 'time-button'; btn.textContent = formatTime(t); btn.dataset.time = t;
                        btn.addEventListener('click', () => { timeContainer.querySelector('.selected')?.classList.remove('selected'); btn.classList.add('selected'); timeInput.value = t; });
                        timeContainer.appendChild(btn);
                    });
                    el('create_account').addEventListener('change', (e) => { el('password-field').classList.toggle('hidden', !e.target.checked); });
                    el('submit-btn').addEventListener('click', submitAndPopulate);
                    el('back-to-vehicle').addEventListener('click', () => renderView('schedulingVehicleType'));
                    break;
            }
        };

        const submitAndPopulate = async () => {
            const getVal = (id) => document.getElementById(id)?.value;
            const payload = {
                full_name: getVal('full_name'), email: getVal('email'), phone: getVal('phone'),
                address: getVal('address'), zip_code: getVal('zip_code'),
                vehicle_year: getVal('vehicle_year'), vehicle_make: getVal('vehicle_make'), vehicle_model: getVal('vehicle_model'),
                package_type: getVal('package_type'), package_price: getVal('package_price'),
                date: getVal('date'), time: getVal('time'),
                create_account: document.getElementById('create_account').checked,
                password: getVal('password'),
                vehicle_type: state.vehicle_type 
            };
            payload.deal_name = `${payload.package_type || 'Detail'} - ${payload.vehicle_make || ''} ${payload.vehicle_model || ''}`;

            if (!payload.full_name || !payload.date || !payload.time) return alert("Name, Date, and Time are required.");

            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true; submitBtn.textContent = 'Submitting...';

            try {
                const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message || `Server error: ${response.status}`);
                
                alert('Appointment submitted successfully!');
                
                document.getElementById('form-full-name').value = payload.full_name;
                document.getElementById('form-email').value = payload.email;
                document.getElementById('form-phone').value = payload.phone;
                document.getElementById('form-address').value = payload.address;
                document.getElementById('form-vehicle-type').value = payload.vehicle_type;
                document.getElementById('form-vehicle-year').value = payload.vehicle_year;
                document.getElementById('form-vehicle-make').value = payload.vehicle_make;
                document.getElementById('form-vehicle-model').value = payload.vehicle_model;
                document.getElementById('form-package-type').value = payload.package_type;
                document.getElementById('form-package-price').value = payload.package_price ? `$${payload.package_price}` : '';
                document.getElementById('form-booking-date').value = formatDate(payload.date);
                document.getElementById('form-booking-time').value = formatTime(payload.time);
                
                renderView('initial');

            } catch (error) {
                console.error('Submission Error:', error);
                alert(`Failed to submit appointment: ${error.message}`);
            } finally {
                submitBtn.disabled = false; submitBtn.textContent = 'Submit Appointment';
            }
        };

        state = {};
        renderView('initial');
    }

    document.addEventListener('DOMContentLoaded', () => {
        if (!window.google) {
            console.warn("Google Maps script not loaded. Initializing app without it.");
            initApp();
        }
    });
    </script>
</body>
</html>
